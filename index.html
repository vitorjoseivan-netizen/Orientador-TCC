<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orientador de TCC Digital</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --primary:#111827;
      --primaryText:#ffffff;
      --danger:#b91c1c;
      --dangerBg:#fee2e2;
      --ok:#065f46;
      --okBg:#d1fae5;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:var(--bg);
    }

    header{
      padding:18px 16px;
      border-bottom:1px solid var(--border);
      background:#fff;
    }

    header .wrap{
      max-width:1100px;
      margin:0 auto;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    h1{
      font-size:18px;
      margin:0;
      font-weight:700;
    }

    .sub{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }

    main{
      max-width:1100px;
      margin:0 auto;
      padding:16px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:16px;
    }

    @media (max-width: 900px){
      main{ grid-template-columns: 1fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 1px 1px rgba(0,0,0,.03);
    }

    .steps{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:8px;
      border-radius:12px;
      background:#fff;
      border:1px solid var(--border);
    }

    .step{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid transparent;
      cursor:pointer;
      user-select:none;
    }

    .step:hover{
      background:#f9fafb;
      border-color:var(--border);
    }

    .step.active{
      background:#111827;
      color:#fff;
      border-color:#111827;
    }

    .step .num{
      width:26px;height:26px;
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#f3f4f6;
      color:#111827;
      font-weight:700;
      flex: 0 0 26px;
    }

    .step.active .num{
      background:#ffffff;
      color:#111827;
    }

    .step .meta{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }

    .step .title{
      font-weight:700;
      font-size:13px;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .step .desc{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .step.active .desc{
      color:#e5e7eb;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    label{
      font-size:12px;
      color:var(--muted);
      display:block;
      margin-bottom:6px;
    }

    select, input[type="text"], textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    textarea{
      min-height:220px;
      resize:vertical;
      line-height:1.4;
    }
    select:focus, input:focus, textarea:focus{
      border-color:#9ca3af;
    }

    .btn{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .btn:hover{ background:#f9fafb; }

    .btn.primary{
      background:var(--primary);
      border-color:var(--primary);
      color:var(--primaryText);
    }
    .btn.primary:disabled{
      opacity:.6;
      cursor:not-allowed;
    }

    .btn.danger{
      background:var(--dangerBg);
      border-color:#fecaca;
      color:var(--danger);
    }

    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:#fff;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      padding:10px 12px;
      border-radius:12px;
      background:#f9fafb;
      border:1px dashed var(--border);
      margin-top:10px;
    }

    .alert{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid;
      font-size:13px;
      line-height:1.35;
      white-space:pre-wrap;
    }

    .alert.ok{
      background:var(--okBg);
      border-color:#a7f3d0;
      color:var(--ok);
    }
    .alert.bad{
      background:var(--dangerBg);
      border-color:#fecaca;
      color:var(--danger);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 700px){
      .grid2{ grid-template-columns:1fr; }
    }

    .small{
      font-size:12px;
      color:var(--muted);
    }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div>
        <h1>Orientador de TCC Digital</h1>
        <div class="sub">Frontend (GitHub Pages) + Backend (Cloudflare Worker) • Endpoint: <span class="mono" id="endpointLabel"></span></div>
      </div>

      <div class="row">
        <span class="pill" id="statusPill">Status: pronto</span>
        <button class="btn" id="btnTestar">Testar /health</button>
      </div>
    </div>
  </header>

  <main>
    <!-- Coluna esquerda: etapas -->
    <section class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <strong>Etapas</strong>
        <span class="small">Clique para navegar</span>
      </div>

      <div style="height:10px;"></div>

      <div class="steps" id="steps"></div>

      <div class="hint">
        Dica: escreva primeiro no campo “Escreva do seu jeito”. Depois clique em <b>Orientar com IA</b>.
        O sistema envia um <b>POST</b> para <span class="mono">/assist</span>.
      </div>
    </section>

    <!-- Coluna direita: editor -->
    <section class="card">
      <div class="grid2">
        <div>
          <label for="stepSelect">Etapa atual</label>
          <select id="stepSelect"></select>
        </div>

        <div>
          <label for="modoEvidencia">
            <input type="checkbox" id="modoEvidencia" />
            Modo Evidência (citar apenas fontes)
          </label>
          <div class="small">Se marcado, a IA deve fundamentar e citar as evidências fornecidas.</div>
        </div>
      </div>

      <div style="height:12px;"></div>

      <label for="textoAluno">Escreva do seu jeito</label>
      <textarea id="textoAluno" placeholder="Digite aqui o seu texto (ex.: tema, problema, objetivos, etc.)"></textarea>

      <div style="height:12px;"></div>

      <div class="row">
        <button class="btn primary" id="btnIA">Orientar com IA</button>
        <button class="btn" id="btnSalvar">Salvar</button>
        <button class="btn" id="btnProxima">Próxima etapa</button>
        <button class="btn danger" id="btnLimpar">Limpar etapa</button>
      </div>

      <div id="alertBox" class="alert" style="display:none;"></div>

      <div style="height:14px;"></div>

      <div class="card" style="padding:12px;background:#fafafa;">
        <strong>Ferramentas</strong>
        <div class="small" style="margin-top:6px;">
          Endpoint do Worker (com <span class="mono">/assist</span>):
          <div class="mono" id="endpointFull" style="margin-top:6px;"></div>
        </div>
        <div class="small" style="margin-top:8px;">
          Observação: abrir o link no navegador mostra “Use POST em /assist”. Isso é normal. O site deve chamar via <b>fetch POST</b>.
        </div>
      </div>
    </section>
  </main>

  <script>
    /***************
     * CONFIGURAÇÃO *
     ***************/
    // Troque aqui se mudar o Worker:
    const WORKER_BASE = "https://orientador-tcc-api.vitorjoseivan.workers.dev";
    const ENDPOINT_ASSIST = WORKER_BASE.replace(/\/+$/, "") + "/assist";
    const ENDPOINT_HEALTH = WORKER_BASE.replace(/\/+$/, "") + "/health";

    // Chave local de armazenamento
    const STORAGE_KEY = "orientador_tcc_v1";

    // Etapas (você pode ajustar os textos)
    const ETAPAS = [
      { id:"tema",      title:"Tema / Introdução", desc:"Defina objeto e contexto" },
      { id:"problema",  title:"Problema de Pesquisa", desc:"Pergunta central" },
      { id:"objetivos", title:"Objetivos", desc:"Geral e específicos" },
      { id:"just",      title:"Justificativa", desc:"Relevância do estudo" },
      { id:"refer",     title:"Referencial Teórico", desc:"Base conceitual" },
      { id:"metodo",    title:"Metodologia", desc:"Como você fará" },
      { id:"crono",     title:"Cronograma", desc:"Planejamento" },
      { id:"pretext",   title:"Elementos Pré-textuais", desc:"Resumo, etc." },
      { id:"refs",      title:"Referências", desc:"Lista final" }
    ];

    /**********************
     * UTILITÁRIOS DE UI  *
     **********************/
    const $ = (id) => document.getElementById(id);

    function showAlert(type, msg){
      const box = $("alertBox");
      box.style.display = "block";
      box.className = "alert " + (type === "ok" ? "ok" : "bad");
      box.textContent = msg;
    }

    function hideAlert(){
      const box = $("alertBox");
      box.style.display = "none";
      box.textContent = "";
    }

    function setStatus(text){
      $("statusPill").textContent = "Status: " + text;
    }

    /***********************
     * PERSISTÊNCIA LOCAL  *
     ***********************/
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return { currentStepId: ETAPAS[0].id, texts: {}, modoEvidencia:false };
        const parsed = JSON.parse(raw);
        return {
          currentStepId: parsed.currentStepId || ETAPAS[0].id,
          texts: parsed.texts || {},
          modoEvidencia: !!parsed.modoEvidencia
        };
      }catch{
        return { currentStepId: ETAPAS[0].id, texts: {}, modoEvidencia:false };
      }
    }

    function saveState(state){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    let state = loadState();

    /***********************
     * RENDER / NAVEGAÇÃO  *
     ***********************/
    function renderSteps(){
      const wrap = $("steps");
      wrap.innerHTML = "";

      ETAPAS.forEach((e, idx) => {
        const div = document.createElement("div");
        div.className = "step" + (state.currentStepId === e.id ? " active" : "");
        div.onclick = () => selectStep(e.id);

        const num = document.createElement("div");
        num.className = "num";
        num.textContent = String(idx + 1);

        const meta = document.createElement("div");
        meta.className = "meta";

        const t = document.createElement("div");
        t.className = "title";
        t.textContent = e.title;

        const d = document.createElement("div");
        d.className = "desc";
        d.textContent = e.desc;

        meta.appendChild(t);
        meta.appendChild(d);

        div.appendChild(num);
        div.appendChild(meta);

        wrap.appendChild(div);
      });
    }

    function renderSelect(){
      const sel = $("stepSelect");
      sel.innerHTML = "";
      ETAPAS.forEach(e => {
        const opt = document.createElement("option");
        opt.value = e.id;
        opt.textContent = e.title;
        sel.appendChild(opt);
      });
      sel.value = state.currentStepId;
    }

    function renderEditor(){
      $("textoAluno").value = state.texts[state.currentStepId] || "";
      $("modoEvidencia").checked = state.modoEvidencia;
      $("stepSelect").value = state.currentStepId;
      renderSteps();
    }

    function selectStep(stepId){
      // salva texto atual antes de trocar
      persistCurrentText();
      state.currentStepId = stepId;
      saveState(state);
      hideAlert();
      renderEditor();
    }

    function persistCurrentText(){
      const txt = $("textoAluno").value || "";
      state.texts[state.currentStepId] = txt;
      saveState(state);
    }

    function nextStep(){
      persistCurrentText();
      const idx = ETAPAS.findIndex(e => e.id === state.currentStepId);
      const next = ETAPAS[Math.min(idx + 1, ETAPAS.length - 1)];
      state.currentStepId = next.id;
      saveState(state);
      hideAlert();
      renderEditor();
    }

    function clearStep(){
      state.texts[state.currentStepId] = "";
      saveState(state);
      $("textoAluno").value = "";
      showAlert("ok", "Etapa limpa com sucesso.");
    }

    /***********************
     * CHAMADA À IA (POST) *
     ***********************/
    async function callAssist(promptText){
      // O Worker exige POST JSON: { prompt: "..." }
      const body = {
        prompt: promptText,
        step: state.currentStepId,
        evidenceMode: state.modoEvidencia ? true : false
      };

      const resp = await fetch(ENDPOINT_ASSIST, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      // Se não for JSON válido, pega texto cru para debug
      const raw = await resp.text();
      let data = null;
      try { data = JSON.parse(raw); } catch { data = { ok:false, error:"Resposta não-JSON do Worker.", raw }; }

      if(!resp.ok){
        return { ok:false, error: data.error || ("HTTP " + resp.status), detail: data.detail || data.raw || raw };
      }
      return data;
    }

    async function orientarComIA(){
      hideAlert();
      setStatus("consultando IA...");

      const txt = ($("textoAluno").value || "").trim();
      if(!txt){
        setStatus("pronto");
        showAlert("bad", "Digite um texto antes de clicar em “Orientar com IA”.");
        return;
      }

      // Persistir antes de chamar
      persistCurrentText();

      // Prompt (controla orientação e, se marcado, pede evidências)
      const prefix = state.modoEvidencia
        ? "Você é um orientador acadêmico. Responda com rigor metodológico e cite apenas as evidências fornecidas pelo usuário (sem inventar referências). Texto do aluno:\n\n"
        : "Você é um orientador acadêmico. Melhore o texto do aluno com clareza metodológica, mantendo a autoria e sugerindo ajustes. Texto do aluno:\n\n";

      try{
        const data = await callAssist(prefix + txt);

        if(data && (data.response || data.text)){
          const out = data.response || data.text;
          $("textoAluno").value = out;
          state.texts[state.currentStepId] = out;
          saveState(state);
          setStatus("pronto");
          showAlert("ok", "Resposta gerada e aplicada ao texto.");
          return;
        }

        // Se veio no formato {ok:false,...}
        setStatus("pronto");
        showAlert("bad", (data && (data.error || data.detail)) ? (data.error + (data.detail ? ("\n\n" + data.detail) : "")) : "A IA não retornou texto.");
      }catch(e){
        setStatus("pronto");
        showAlert("bad", "Falha ao conectar com o Worker:\n" + e.message + "\n\nVerifique:\n- se o endpoint está correto;\n- se o Worker está publicado (Deploy);\n- se há bloqueio de rede/CORS.");
      }
    }

    async function testarHealth(){
      hideAlert();
      setStatus("testando...");
      try{
        const resp = await fetch(ENDPOINT_HEALTH, { method: "GET" });
        const raw = await resp.text();
        let data = null;
        try { data = JSON.parse(raw); } catch { data = { raw }; }

        if(resp.ok && data && data.ok === true){
          setStatus("online");
          showAlert("ok", "Worker online em /health.");
        }else{
          setStatus("atenção");
          showAlert("bad", "Resposta inesperada de /health:\n" + raw);
        }
      }catch(e){
        setStatus("offline");
        showAlert("bad", "Não foi possível acessar /health.\n" + e.message);
      }
    }

    /***********************
     * EVENTOS / INIT      *
     ***********************/
    function init(){
      $("endpointLabel").textContent = WORKER_BASE;
      $("endpointFull").textContent = ENDPOINT_ASSIST;

      // Preenche select
      renderSelect();

      // Render inicial
      renderEditor();

      // Eventos
      $("stepSelect").addEventListener("change", (e) => selectStep(e.target.value));

      $("modoEvidencia").addEventListener("change", () => {
        state.modoEvidencia = $("modoEvidencia").checked;
        saveState(state);
      });

      $("btnSalvar").addEventListener("click", () => {
        persistCurrentText();
        showAlert("ok", "Salvo localmente (neste navegador).");
      });

      $("btnProxima").addEventListener("click", nextStep);
      $("btnLimpar").addEventListener("click", clearStep);
      $("btnIA").addEventListener("click", orientarComIA);
      $("btnTestar").addEventListener("click", testarHealth);
    }

    init();
  </script>
</body>
</html>
```0
