<!doctype html>
<html lang="pt-BR">
<head>
 <meta charset="utf-8" />
 <meta name="viewport" content="width=device-width,initial-scale=1" />
 <title>Orientador de TCC Digital | Premium</title>
 
 <link rel="preconnect" href="https://fonts.googleapis.com">
 <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
 
 <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
 
 <style>
   :root {
     --bg: #0b1020; 
     --bg-panel: rgba(255,255,255,0.05);
     --card: rgba(255,255,255,0.08); 
     --line: rgba(255,255,255,0.12);
     --text: #eef3ff; 
     --muted: #b9c6f3;
     --p1: #7c5cff; 
     --p2: #33d69f; 
     --danger: #ff5c7c;
     --shadow: 0 12px 40px rgba(0,0,0,0.4);
   }

   * { box-sizing: border-box; }
   body {
     margin: 0; font-family: 'Inter', sans-serif; color: var(--text);
     background: radial-gradient(1000px 600px at 10% 0%, rgba(124,92,255,0.2), transparent 70%), var(--bg);
     height: 100vh; overflow: hidden;
   }

   .topbar {
     height: 64px; display: flex; align-items: center; justify-content: space-between;
     padding: 0 20px; border-bottom: 1px solid var(--line);
     backdrop-filter: blur(10px); background: rgba(11,16,32,0.8);
   }

   .layout {
     display: grid; grid-template-columns: 320px 1fr; gap: 15px;
     height: calc(100vh - 64px); padding: 15px;
   }

   .panel {
     background: var(--bg-panel); border: 1px solid var(--line);
     border-radius: 20px; display: flex; flex-direction: column; overflow: hidden;
     box-shadow: var(--shadow);
   }

   .scroll { overflow-y: auto; padding: 15px; flex: 1; }
   
   .section-item {
     width: 100%; padding: 15px; border-radius: 12px; background: rgba(255,255,255,0.03);
     border: 1px solid transparent; color: var(--text); text-align: left;
     margin-bottom: 8px; cursor: pointer; transition: 0.3s;
   }
   .section-item:hover { background: rgba(124,92,255,0.1); }
   .section-item.active { background: rgba(124,92,255,0.2); border-color: var(--p1); }

   textarea {
     width: 100%; background: rgba(0,0,0,0.4); border: 1px solid var(--line);
     border-radius: 12px; color: white; padding: 12px; font-family: inherit;
     font-size: 14px; line-height: 1.6; resize: none; margin-bottom: 15px;
   }

   .btn {
     padding: 10px 18px; border-radius: 10px; border: 1px solid var(--line);
     cursor: pointer; font-weight: 600; font-family: inherit; transition: 0.2s;
   }
   .btn-primary { background: var(--p1); color: white; border: none; }
   .btn-ghost { background: transparent; color: var(--muted); }

   .terminal {
     background: #050814; padding: 12px; border-radius: 10px;
     font-family: monospace; font-size: 12px; color: #33d69f;
     border: 1px solid var(--line); min-height: 60px; margin-top: 10px;
   }

   #drawer {
     position: fixed; right: -400px; top: 0; width: 350px; height: 100%;
     background: #0b1020; border-left: 1px solid var(--line);
     z-index: 1000; transition: 0.4s; padding: 20px;
   }
   #drawer.open { right: 0; }
   .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; z-index: 999; }
 </style>
</head>
<body>

<div class="overlay" id="overlay" onclick="toggleDrawer(false)"></div>

<header class="topbar">
  <div style="display:flex; align-items:center; gap:12px">
    <div style="font-weight:900; font-size:20px; color:var(--p1)">Orientador Digital</div>
  </div>
  <div style="display:flex; gap:10px">
    <button class="btn btn-ghost" onclick="toggleDrawer(true)">Configurações</button>
    <button class="btn btn-primary" onclick="exportWord()">Baixar Word</button>
  </div>
</header>

<div class="layout">
  <aside class="panel">
    <div style="padding:15px; border-bottom:1px solid var(--line)"><h4>Estrutura TCC</h4></div>
    <div class="scroll" id="stepsList"></div>
  </aside>

  <main class="panel">
    <div class="scroll">
      <h2 id="sectionTitle">Selecione uma etapa</h2>
      
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div>
          <label style="font-size:11px; text-transform:uppercase; color:var(--muted)">Briefing para IA</label>
          <textarea id="briefingInput" style="height:120px" placeholder="O que a IA deve escrever?"></textarea>
          <button class="btn btn-primary" id="btnIA" onclick="callIA()" style="width:100%">Gerar com IA</button>
        </div>
        <div>
          <label style="font-size:11px; text-transform:uppercase; color:var(--muted)">Referências / PDF</label>
          <textarea id="evidenceInput" style="height:120px" placeholder="Texto do PDF aparecerá aqui..."></textarea>
          <input type="file" id="pdfFile" accept=".pdf" style="display:none" onchange="extractPDF()">
          <button class="btn btn-ghost" style="width:100%" onclick="document.getElementById('pdfFile').click()">Anexar PDF</button>
        </div>
      </div>

      <h4 style="margin-top:20px">Conteúdo Final</h4>
      <textarea id="mainContent" style="height:280px" oninput="saveCurrentData()"></textarea>
      
      <div class="terminal" id="terminal">Pronto para iniciar.</div>
    </div>
  </main>
</div>

<div id="drawer">
  <h3>Configurações</h3>
  <label>URL do Worker Cloudflare</label>
  <input type="text" id="workerUrl" style="width:100%; padding:10px; margin:10px 0; border-radius:8px; border:1px solid var(--line); background:#000; color:white;">
  <button class="btn btn-primary" style="width:100%; margin-top:20px" onclick="saveConfig()">Salvar e Fechar</button>
</div>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.min.js";

  const STRUCTURE = [
    { id: 'intro', title: '1. Introdução' },
    { id: 'prob', title: '2. Problema' },
    { id: 'obj', title: '3. Objetivos' },
    { id: 'just', title: '4. Justificativa' },
    { id: 'ref', title: '5. Referencial Teórico' },
    { id: 'meto', title: '6. Metodologia' },
    { id: 'concl', title: '7. Conclusão' },
    { id: 'refere', title: '8. Referências' }
  ];

  let state = JSON.parse(localStorage.getItem('tcc_state_v2')) || {
    config: { worker: "https://orientador-tcc-api.vitorjoseivan.workers.dev/assist" },
    activeId: 'intro',
    data: {}
  };

  function init() {
    renderSteps();
    loadStep(state.activeId);
    document.getElementById('workerUrl').value = state.config.worker;
  }

  function renderSteps() {
    const list = document.getElementById('stepsList');
    list.innerHTML = "";
    STRUCTURE.forEach(s => {
      const btn = document.createElement('button');
      btn.className = `section-item ${state.activeId === s.id ? 'active' : ''}`;
      btn.innerHTML = `<strong>${s.title}</strong>`;
      btn.onclick = () => loadStep(s.id);
      list.appendChild(btn);
    });
  }

  function loadStep(id) {
    state.activeId = id;
    const s = STRUCTURE.find(x => x.id === id);
    document.getElementById('sectionTitle').innerText = s.title;
    document.getElementById('mainContent').value = state.data[id]?.content || "";
    document.getElementById('evidenceInput').value = state.data[id]?.evidence || "";
    renderSteps();
  }

  function saveCurrentData() {
    if(!state.data[state.activeId]) state.data[state.activeId] = {};
    state.data[state.activeId].content = document.getElementById('mainContent').value;
    state.data[state.activeId].evidence = document.getElementById('evidenceInput').value;
    localStorage.setItem('tcc_state_v2', JSON.stringify(state));
  }

  async function callIA() {
    const briefing = document.getElementById('briefingInput').value;
    const terminal = document.getElementById('terminal');
    const btn = document.getElementById('btnIA');

    if(!briefing) return terminal.innerText = "Erro: Digite o briefing!";

    btn.disabled = true;
    terminal.innerText = "Consultando IA...";

    try {
        const response = await fetch(state.config.worker, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                prompt: briefing, // Envia como prompt para o Worker
                etapa: state.activeId,
                evidencia: document.getElementById('evidenceInput').value
            })
        });

        const data = await response.json();
        const texto = data.text || data.resultado || data.answer || "";

        if(texto) {
            document.getElementById('mainContent').value = texto;
            saveCurrentData();
            terminal.innerText = "Sucesso: Conteúdo gerado!";
        } else {
            terminal.innerText = "Erro: IA não devolveu texto. Verifique o Worker.";
        }
    } catch (e) {
        terminal.innerText = "Erro: Falha na conexão com o Worker.";
    } finally {
        btn.disabled = false;
    }
  }

  async function extractPDF() {
    const file = document.getElementById('pdfFile').files[0];
    if(!file) return;
    document.getElementById('terminal').innerText = "Extraindo PDF...";
    const reader = new FileReader();
    reader.onload = async function() {
        const pdf = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
        let text = "";
        for(let i=1; i<=pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          text += content.items.map(it => it.str).join(" ") + " ";
        }
        document.getElementById('evidenceInput').value = text;
        saveCurrentData();
        document.getElementById('terminal').innerText = "PDF Extraído!";
    };
    reader.readAsArrayBuffer(file);
  }

  function toggleDrawer(open) {
    document.getElementById('drawer').className = open ? 'open' : '';
    document.getElementById('overlay').style.display = open ? 'block' : 'none';
  }

  function saveConfig() {
    state.config.worker = document.getElementById('workerUrl').value;
    localStorage.setItem('tcc_state_v2', JSON.stringify(state));
    toggleDrawer(false);
  }

  async function exportWord() {
    const { Document, Packer, Paragraph, TextRun } = window.docx;
    const children = [];
    STRUCTURE.forEach(s => {
      if(state.data[s.id]?.content) {
        children.push(new Paragraph({ text: s.title, heading: "Heading1" }));
        children.push(new Paragraph({ children: [new TextRun(state.data[s.id].content)] }));
      }
    });
    const doc = new Document({ sections: [{ children }] });
    const blob = await Packer.toBlob(doc);
    saveAs(blob, "TCC_Digital.docx");
  }

  init();
</script>
</body>
</html>
