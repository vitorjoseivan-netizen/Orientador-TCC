<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orientador de TCC Digital</title>

  <!-- Visual: fonte moderna -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- (Opcional) Exportar DOCX -->
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    :root{
      --bg:#0b1020;
      --panel:#101a33;
      --panel2:#0e1730;
      --card:#111c39;
      --text:#e8eeff;
      --muted:#9fb0da;
      --line:rgba(255,255,255,.10);
      --accent:#7c5cff;
      --accent2:#33d69f;
      --danger:#ff5c7c;
      --warn:#ffd15c;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 700px at 15% 0%, rgba(124,92,255,.25), transparent 60%),
        radial-gradient(900px 600px at 90% 15%, rgba(51,214,159,.18), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    a{color:inherit}

    /* Layout */
    .app{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      height:100vh;
      padding:18px;
    }
    .sidebar, .main{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-radius:var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sidebar{
      display:flex;
      flex-direction:column;
      min-width:280px;
    }
    .main{
      display:flex;
      flex-direction:column;
      min-width:0;
    }

    /* Top bars */
    .sb-top, .main-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 16px 14px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.02);
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .brand h1{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
      font-weight:700;
    }
    .brand small{
      color:var(--muted);
      font-size:12px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
      background:rgba(255,255,255,.02);
      user-select:none;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background:var(--warn);
      box-shadow:0 0 0 3px rgba(255,209,92,.15);
    }
    .dot.ok{background:var(--accent2); box-shadow:0 0 0 3px rgba(51,214,159,.15);}
    .dot.bad{background:var(--danger); box-shadow:0 0 0 3px rgba(255,92,124,.15);}

    /* Sidebar sections */
    .sb-body{
      padding:14px;
      overflow:auto;
    }
    .section{
      background:rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px;
      margin-bottom:12px;
    }
    .section h3{
      margin:0 0 10px;
      font-size:12px;
      color:var(--muted);
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.12em;
    }

    /* Steps */
    .steps{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .step{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px;
      border-radius:14px;
      border:1px solid transparent;
      cursor:pointer;
      transition:.15s ease;
      background:rgba(255,255,255,.02);
    }
    .step:hover{
      border-color:rgba(124,92,255,.35);
      background:rgba(124,92,255,.08);
    }
    .step.active{
      border-color:rgba(124,92,255,.55);
      background:rgba(124,92,255,.14);
    }
    .badge{
      width:24px;height:24px;
      border-radius:8px;
      background:rgba(124,92,255,.22);
      border:1px solid rgba(124,92,255,.35);
      display:flex;align-items:center;justify-content:center;
      font-size:12px;font-weight:700;
      flex:0 0 auto;
    }
    .step .meta{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .step .title{
      font-size:13px;
      font-weight:600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .step .sub{
      font-size:12px;
      color:var(--muted);
    }

    /* File upload */
    .upload-row{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      transition:.15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.20);}
    .btn.primary{
      background:linear-gradient(180deg, rgba(124,92,255,.95), rgba(124,92,255,.72));
      border-color:rgba(124,92,255,.65);
    }
    .btn.primary:hover{border-color:rgba(124,92,255,.85);}
    .btn.danger{
      background:rgba(255,92,124,.10);
      border-color:rgba(255,92,124,.35);
      color:#ffdbe2;
    }
    .btn.ghost{
      background:transparent;
    }
    input[type="file"]{display:none;}
    .files{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:220px;
      overflow:auto;
      padding-right:4px;
    }
    .file{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(255,255,255,.02);
    }
    .file .name{
      font-size:12px;
      color:var(--text);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
    }
    .file .actions{
      display:flex; gap:8px; flex:0 0 auto;
    }
    .icon{
      width:34px;height:34px;border-radius:10px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;
      color:var(--muted);
      font-weight:800;
      font-size:12px;
    }

    /* Main content */
    .main-top{
      gap:12px;
    }
    .main-top .left{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .main-top h2{
      margin:0;
      font-size:16px;
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .main-top .desc{
      margin:0;
      color:var(--muted);
      font-size:12px;
    }
    .toolbar{
      display:flex;
      align-items:center;
      gap:10px;
      flex:0 0 auto;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .content{
      display:grid;
      grid-template-rows: auto 1fr auto;
      gap:12px;
      padding:14px;
      height:100%;
      overflow:hidden;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      min-height:0;
    }

    .card{
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      border-radius:var(--radius);
      padding:12px;
      min-width:0;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .card h3{
      margin:0;
      font-size:12px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
      font-weight:700;
    }
    textarea{
      width:100%;
      min-height:260px;
      resize:vertical;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:12px;
      font-size:13px;
      line-height:1.55;
      outline:none;
    }
    textarea:focus{
      border-color:rgba(124,92,255,.55);
      box-shadow:0 0 0 3px rgba(124,92,255,.15);
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      line-height:1.5;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .switch{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .switch input{
      width:42px;height:24px;
      appearance:none;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      position:relative;
      cursor:pointer;
      outline:none;
      transition:.15s ease;
    }
    .switch input:checked{
      background:rgba(51,214,159,.25);
      border-color:rgba(51,214,159,.35);
    }
    .switch input::after{
      content:"";
      width:18px;height:18px;
      border-radius:50%;
      background:rgba(255,255,255,.85);
      position:absolute;
      top:50%;
      left:4px;
      transform:translateY(-50%);
      transition:.15s ease;
    }
    .switch input:checked::after{left:20px;}
    .switch label{
      font-size:12px;
      color:var(--text);
      font-weight:600;
    }

    .statusbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 14px;
      border-top:1px solid var(--line);
      background:rgba(255,255,255,.02);
      font-size:12px;
      color:var(--muted);
    }
    .statusbar b{color:var(--text);}
    .log{
      white-space:pre-wrap;
      word-break:break-word;
      font-size:12px;
      line-height:1.45;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      border-radius:14px;
      padding:12px;
      overflow:auto;
      min-height:260px;
    }

    /* Responsive */
    @media (max-width: 980px){
      .app{grid-template-columns:1fr; height:auto;}
      .grid{grid-template-columns:1fr;}
      .sidebar{order:2}
      .main{order:1; height:auto; min-height:70vh;}
    }

    /* Print (Export PDF) */
    @media print{
      body{background:#fff; color:#000;}
      .sidebar,.main-top,.statusbar,.toolbar,.btn{display:none !important;}
      .main{border:none; box-shadow:none;}
      .content{padding:0;}
      .grid{grid-template-columns:1fr;}
      textarea, .log{
        border:1px solid #ddd;
        background:#fff;
        color:#000;
        min-height:auto;
      }
      textarea{
        height:auto !important;
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sb-top">
        <div class="brand">
          <h1>Orientador de TCC Digital</h1>
          <small>Frontend + Worker (POST /assist)</small>
        </div>
        <div class="pill" title="Status do serviço">
          <span id="svcDot" class="dot"></span>
          <span id="svcText">verificando…</span>
        </div>
      </div>

      <div class="sb-body">
        <div class="section">
          <h3>Etapas</h3>
          <div class="steps" id="steps"></div>
        </div>

        <div class="section">
          <h3>Anexos (PDF)</h3>
          <div class="upload-row">
            <label class="btn" for="pdfInput">Anexar PDF</label>
            <input id="pdfInput" type="file" accept="application/pdf" multiple />
            <button class="btn danger" id="clearPdfsBtn" type="button">Limpar PDFs</button>
          </div>
          <div class="hint" style="margin-top:10px;">
            Os PDFs ficam no seu navegador (local). Para usar “Modo Evidência”, você pode colar trechos relevantes no campo “Evidências”.
          </div>
          <div class="files" id="pdfList"></div>
        </div>

        <div class="section">
          <h3>Exportação</h3>
          <div class="upload-row" style="flex-wrap:wrap;">
            <button class="btn" id="exportPdfBtn" type="button">Exportar PDF</button>
            <button class="btn" id="exportDocxBtn" type="button">Exportar DOCX</button>
            <button class="btn ghost" id="resetAllBtn" type="button">Reset geral</button>
          </div>
          <div class="hint" style="margin-top:10px;">
            Exportar PDF usa impressão do navegador (formato limpo). DOCX gera um arquivo Word simples com o texto da etapa.
          </div>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="main-top">
        <div class="left">
          <h2 id="stepTitle">—</h2>
          <p class="desc" id="stepDesc">—</p>
        </div>

        <div class="toolbar">
          <div class="switch" title="Quando ativo, peça para a IA citar evidências fornecidas por você.">
            <input id="evidenceToggle" type="checkbox" />
            <label for="evidenceToggle">Modo Evidência</label>
          </div>
          <button class="btn" id="saveBtn" type="button">Salvar</button>
          <button class="btn primary" id="askBtn" type="button">Orientar com IA</button>
          <button class="btn danger" id="clearStepBtn" type="button">Limpar etapa</button>
        </div>
      </div>

      <div class="content">
        <div class="grid">
          <section class="card">
            <h3>Seu texto</h3>
            <textarea id="userText" placeholder="Escreva aqui o conteúdo desta etapa do TCC..."></textarea>
            <div class="row">
              <span class="hint">Autosave ativo. Último salvamento: <b id="lastSaved">—</b></span>
              <span class="hint">Progresso: <b id="progress">0%</b></span>
            </div>
          </section>

          <section class="card">
            <h3>Evidências / Trechos de apoio</h3>
            <textarea id="evidenceText" placeholder="Cole aqui trechos de PDFs, citações, notas, referências, dados, etc. (Opcional, mas recomendado no Modo Evidência)."></textarea>
            <div class="hint">
              Dica: se a IA “inventar”, ative o Modo Evidência e alimente esta área com trechos reais (copiados do PDF).
            </div>
          </section>
        </div>

        <section class="card" style="min-height:0;">
          <h3>Resposta da IA</h3>
          <div id="aiOut" class="log">—</div>
        </section>
      </div>

      <div class="statusbar">
        <span>Status: <b id="runtimeStatus">pronto</b></span>
        <span>Endpoint: <b id="endpointLabel">/assist</b></span>
      </div>
    </main>
  </div>

  <script>
    // ---------------------------
    // Configuração de etapas
    // ---------------------------
    const STEPS = [
      { id: "tema", title: "Tema / Introdução", desc: "Delimite o tema e contextualize o problema." },
      { id: "problema", title: "Problema de Pesquisa", desc: "Formule a pergunta central e o recorte." },
      { id: "objetivos", title: "Objetivos", desc: "Geral e específicos (com verbos no infinitivo)." },
      { id: "justificativa", title: "Justificativa", desc: "Relevância acadêmica e social; por que vale pesquisar." },
      { id: "referencial", title: "Referencial Teórico", desc: "Base conceitual (autores, conceitos, categorias)." },
      { id: "metodologia", title: "Metodologia", desc: "Abordagem, tipo de pesquisa, técnicas e instrumentos." },
      { id: "cronograma", title: "Cronograma", desc: "Planejamento por etapas e prazos." },
      { id: "elementos", title: "Elementos Pré-textuais", desc: "Resumo, palavras-chave, abstract, etc." },
      { id: "referencias", title: "Referências", desc: "Lista final em padrão exigido pela instituição/revista." }
    ];

    // ---------------------------
    // Storage keys
    // ---------------------------
    const STORE_KEY = "orientador_tcc_v2";
    const STORE_PDFS = "orientador_pdfs_v2";
    const STORE_ACTIVE = "orientador_active_step_v2";
    const STORE_EVID = "orientador_evidence_v2";
    const STORE_EVID_TOGGLE = "orientador_evidence_toggle_v2";

    // ---------------------------
    // DOM
    // ---------------------------
    const stepsEl = document.getElementById("steps");
    const stepTitleEl = document.getElementById("stepTitle");
    const stepDescEl = document.getElementById("stepDesc");
    const userTextEl = document.getElementById("userText");
    const evidenceTextEl = document.getElementById("evidenceText");
    const aiOutEl = document.getElementById("aiOut");
    const lastSavedEl = document.getElementById("lastSaved");
    const progressEl = document.getElementById("progress");

    const pdfInputEl = document.getElementById("pdfInput");
    const pdfListEl = document.getElementById("pdfList");
    const clearPdfsBtn = document.getElementById("clearPdfsBtn");

    const saveBtn = document.getElementById("saveBtn");
    const askBtn = document.getElementById("askBtn");
    const clearStepBtn = document.getElementById("clearStepBtn");
    const resetAllBtn = document.getElementById("resetAllBtn");
    const exportPdfBtn = document.getElementById("exportPdfBtn");
    const exportDocxBtn = document.getElementById("exportDocxBtn");

    const evidenceToggleEl = document.getElementById("evidenceToggle");
    const runtimeStatusEl = document.getElementById("runtimeStatus");
    const svcDot = document.getElementById("svcDot");
    const svcText = document.getElementById("svcText");

    // ---------------------------
    // Estado
    // ---------------------------
    let activeStep = localStorage.getItem(STORE_ACTIVE) || STEPS[0].id;

    function loadStore(){
      try {
        return JSON.parse(localStorage.getItem(STORE_KEY) || "{}");
      } catch {
        return {};
      }
    }
    function saveStore(data){
      localStorage.setItem(STORE_KEY, JSON.stringify(data));
      lastSavedEl.textContent = new Date().toLocaleString();
      updateProgress();
    }

    function loadPdfs(){
      try { return JSON.parse(localStorage.getItem(STORE_PDFS) || "[]"); } catch { return []; }
    }
    function savePdfs(list){
      localStorage.setItem(STORE_PDFS, JSON.stringify(list));
      renderPdfs();
    }

    function setStatus(type, text){
      runtimeStatusEl.textContent = text;
      svcText.textContent = text;
      svcDot.classList.remove("ok","bad");
      if(type === "ok") svcDot.classList.add("ok");
      if(type === "bad") svcDot.classList.add("bad");
    }

    // ---------------------------
    // Render steps
    // ---------------------------
    function renderSteps(){
      stepsEl.innerHTML = "";
      const store = loadStore();

      STEPS.forEach((s, idx) => {
        const filled = (store[s.id] || "").trim().length > 0;
        const el = document.createElement("div");
        el.className = "step" + (s.id === activeStep ? " active" : "");
        el.innerHTML = `
          <div class="badge">${idx+1}</div>
          <div class="meta">
            <div class="title">${s.title}</div>
            <div class="sub">${filled ? "Preenchida" : "Vazia"}</div>
          </div>
        `;
        el.addEventListener("click", () => {
          activeStep = s.id;
          localStorage.setItem(STORE_ACTIVE, activeStep);
          openStep(activeStep);
          renderSteps();
        });
        stepsEl.appendChild(el);
      });
      updateProgress();
    }

    function openStep(stepId){
      const s = STEPS.find(x => x.id === stepId) || STEPS[0];
      const store = loadStore();

      stepTitleEl.textContent = s.title;
      stepDescEl.textContent = s.desc;

      userTextEl.value = store[stepId] || "";
      evidenceTextEl.value = localStorage.getItem(STORE_EVID) || "";
      evidenceToggleEl.checked = (localStorage.getItem(STORE_EVID_TOGGLE) === "true");

      aiOutEl.textContent = "—";
    }

    function updateProgress(){
      const store = loadStore();
      const total = STEPS.length;
      let done = 0;
      for(const s of STEPS){
        if((store[s.id] || "").trim().length > 0) done++;
      }
      const pct = Math.round((done/total)*100);
      progressEl.textContent = `${pct}%`;
    }

    // ---------------------------
    // PDF management (metadata only)
    // ---------------------------
    function renderPdfs(){
      const list = loadPdfs();
      pdfListEl.innerHTML = "";
      if(list.length === 0){
        const empty = document.createElement("div");
        empty.className = "hint";
        empty.textContent = "Nenhum PDF anexado ainda.";
        pdfListEl.appendChild(empty);
        return;
      }

      for(const item of list){
        const row = document.createElement("div");
        row.className = "file";
        row.innerHTML = `
          <div style="display:flex;align-items:center;gap:10px;min-width:0;">
            <div class="icon">PDF</div>
            <div class="name" title="${escapeHtml(item.name)}">${escapeHtml(item.name)}</div>
          </div>
          <div class="actions">
            <button class="btn danger" data-id="${item.id}" type="button">Remover</button>
          </div>
        `;
        row.querySelector("button").addEventListener("click", () => {
          const updated = loadPdfs().filter(x => x.id !== item.id);
          savePdfs(updated);
        });
        pdfListEl.appendChild(row);
      }
    }

    function escapeHtml(str){
      return (str||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
                      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    pdfInputEl.addEventListener("change", async (e) => {
      const files = Array.from(e.target.files || []);
      if(files.length === 0) return;

      // Guardamos apenas metadados (nome, tamanho) no localStorage.
      // Se quiser leitura real de PDF no navegador (pdf.js + extração), eu implemento na próxima versão.
      const list = loadPdfs();
      for(const f of files){
        list.push({
          id: crypto.randomUUID(),
          name: f.name,
          size: f.size,
          addedAt: Date.now()
        });
      }
      savePdfs(list);
      pdfInputEl.value = "";
    });

    clearPdfsBtn.addEventListener("click", () => {
      savePdfs([]);
    });

    // ---------------------------
    // Save / autosave
    // ---------------------------
    function saveCurrentStep(){
      const store = loadStore();
      store[activeStep] = userTextEl.value;
      saveStore(store);

      localStorage.setItem(STORE_EVID, evidenceTextEl.value);
      localStorage.setItem(STORE_EVID_TOGGLE, evidenceToggleEl.checked ? "true" : "false");

      renderSteps();
    }

    let autosaveTimer = null;
    function scheduleAutosave(){
      if(autosaveTimer) clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(saveCurrentStep, 600);
    }

    userTextEl.addEventListener("input", scheduleAutosave);
    evidenceTextEl.addEventListener("input", () => {
      localStorage.setItem(STORE_EVID, evidenceTextEl.value);
    });
    evidenceToggleEl.addEventListener("change", () => {
      localStorage.setItem(STORE_EVID_TOGGLE, evidenceToggleEl.checked ? "true" : "false");
    });

    saveBtn.addEventListener("click", saveCurrentStep);

    clearStepBtn.addEventListener("click", () => {
      userTextEl.value = "";
      saveCurrentStep();
      aiOutEl.textContent = "—";
    });

    resetAllBtn.addEventListener("click", () => {
      localStorage.removeItem(STORE_KEY);
      localStorage.removeItem(STORE_PDFS);
      localStorage.removeItem(STORE_EVID);
      localStorage.removeItem(STORE_EVID_TOGGLE);
      localStorage.removeItem(STORE_ACTIVE);
      activeStep = STEPS[0].id;
      localStorage.setItem(STORE_ACTIVE, activeStep);
      renderPdfs();
      renderSteps();
      openStep(activeStep);
      lastSavedEl.textContent = "—";
      aiOutEl.textContent = "—";
    });

    // ---------------------------
    // Health check
    // ---------------------------
    async function checkHealth(){
      try{
        const r = await fetch("/health", { method:"GET" });
        const j = await r.json().catch(() => ({}));
        if(r.ok && j.ok){
          setStatus("ok","online");
        }else{
          setStatus("bad","offline");
        }
      }catch{
        setStatus("bad","offline");
      }
    }

    // ---------------------------
    // Call IA (POST /assist)
    // ---------------------------
    async function callAssist(){
      saveCurrentStep();

      const stepInfo = STEPS.find(s => s.id === activeStep);
      const evidenceMode = evidenceToggleEl.checked;

      const userText = userTextEl.value.trim();
      const evid = (evidenceTextEl.value || "").trim();

      if(!userText){
        aiOutEl.textContent = "Escreva algo no campo 'Seu texto' para eu orientar esta etapa.";
        return;
      }

      runtimeStatusEl.textContent = "consultando IA…";
      aiOutEl.textContent = "Gerando orientação…";

      // Prompt de controle (não “robótico”, mas bem guiado)
      const systemGuide =
`Você é um orientador acadêmico. Ajude o aluno a melhorar a etapa "${stepInfo.title}" do TCC.
Entregue uma orientação clara, didática, sem linguagem robótica.
Regras:
- Não invente referências.
- Se o Modo Evidência estiver ligado, cite explicitamente trechos da seção "EVIDÊNCIAS" (entre aspas) e diga onde foram usados.
- Estruture em: (1) Diagnóstico, (2) Ajustes sugeridos, (3) Exemplo reescrito (curto), (4) Próximos passos.
- Linguagem em português do Brasil.
`;

      const payload = {
        stepId: activeStep,
        stepTitle: stepInfo.title,
        evidenceMode,
        text: userText,
        evidences: evid,
        guide: systemGuide
      };

      try{
        const res = await fetch("/assist", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));

        if(!res.ok){
          const msg = data?.error || `Erro HTTP ${res.status}`;
          aiOutEl.textContent = `Falha ao chamar /assist: ${msg}`;
          runtimeStatusEl.textContent = "erro";
          return;
        }

        // Aceita formatos diferentes do backend (data.text / data.output / data.answer)
        const out = data.text || data.output || data.answer || data.result || "";
        aiOutEl.textContent = out ? out : "A IA não retornou texto. Verifique o Worker e o modelo configurado.";
        runtimeStatusEl.textContent = "pronto";
      }catch(err){
        aiOutEl.textContent = "Erro de rede ao chamar /assist. Verifique o Worker, CORS e se o endpoint está online.";
        runtimeStatusEl.textContent = "erro";
      }
    }

    askBtn.addEventListener("click", callAssist);

    // ---------------------------
    // Export PDF (print)
    // ---------------------------
    exportPdfBtn.addEventListener("click", () => {
      // Sugestão: antes de imprimir, garantir salvamento
      saveCurrentStep();
      window.print();
    });

    // ---------------------------
    // Export DOCX
    // ---------------------------
    exportDocxBtn.addEventListener("click", async () => {
      try{
        saveCurrentStep();

        const stepInfo = STEPS.find(s => s.id === activeStep);
        const text = userTextEl.value || "";
        const evid = evidenceTextEl.value || "";

        if(!window.docx || !window.saveAs){
          alert("Bibliotecas de DOCX não carregaram. Verifique sua internet ou remova a opção DOCX.");
          return;
        }

        const { Document, Packer, Paragraph, TextRun, HeadingLevel } = window.docx;

        const doc = new Document({
          sections: [{
            properties: {},
            children: [
              new Paragraph({ text: "Orientador de TCC Digital", heading: HeadingLevel.TITLE }),
              new Paragraph({ text: stepInfo.title, heading: HeadingLevel.HEADING_1 }),
              new Paragraph({ children: [ new TextRun(text) ] }),
              new Paragraph({ text: "" }),
              new Paragraph({ text: "Evidências / Apoio", heading: HeadingLevel.HEADING_2 }),
              new Paragraph({ children: [ new TextRun(evid || "—") ] })
            ]
          }]
        });

        const blob = await Packer.toBlob(doc);
        window.saveAs(blob, `tcc_${stepInfo.id}.docx`);
      }catch(e){
        alert("Falha ao exportar DOCX: " + (e?.message || e));
      }
    });

    // ---------------------------
    // Init
    // ---------------------------
    (function init(){
      renderSteps();
      renderPdfs();
      openStep(activeStep);

      // Marca último salvamento se existir
      const existing = localStorage.getItem(STORE_KEY);
      if(existing) lastSavedEl.textContent = "carregado do navegador";

      checkHealth();
      setInterval(checkHealth, 15000);
    })();
  </script>
</body>
</html>
