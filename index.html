<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orientador de TCC Digital</title>

  <!-- PDF (jsPDF) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Word (docx + FileSaver) -->
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:rgba(15,23,42,.12);
      --shadow:0 12px 30px rgba(2,6,23,.08);
      --radius:18px;
      --radius-lg:24px;

      --brand:#ffb100;            /* amarelo */
      --brand-2:#2563eb;          /* azul */
      --brand-3:#22c55e;          /* verde */

      --mono:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 420px at 10% 0%, rgba(255,177,0,.18), transparent 60%),
        radial-gradient(900px 420px at 90% 10%, rgba(37,99,235,.14), transparent 60%),
        radial-gradient(900px 420px at 40% 100%, rgba(34,197,94,.10), transparent 55%),
        var(--bg);
    }

    .topbar{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(246,248,251,.75);
      border-bottom:1px solid var(--border);
    }
    .topbar-inner{
      max-width:1100px;
      margin:0 auto;
      padding:12px 14px;
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:space-between;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 220px;
    }
    .logo{
      width:42px; height:42px;
      border-radius:14px;
      background: linear-gradient(135deg, var(--brand), #ffd36a);
      box-shadow: 0 10px 22px rgba(255,177,0,.25);
      display:grid; place-items:center;
      font-weight:900;
    }
    .brand h1{
      margin:0;
      font-size:16px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .brand p{
      margin:0;
      font-size:12px;
      color:var(--muted);
    }

    .toolbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border:1px solid var(--border);
      background: #fff;
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:800;
      cursor:pointer;
      box-shadow: 0 8px 18px rgba(2,6,23,.06);
      transition: transform .05s ease, background .15s ease, opacity .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }
    .btn.primary{
      background: var(--brand);
      border-color: rgba(0,0,0,.06);
    }
    .btn.primary:hover{ background:#ffc02a; }
    .btn.blue{
      background: rgba(37,99,235,.10);
      border-color: rgba(37,99,235,.22);
    }
    .btn.ghost{
      background: rgba(255,255,255,.65);
    }

    .pill{
      display:flex; align-items:center; gap:8px;
      font-size:13px;
      color:var(--muted);
      user-select:none;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.70);
      border:1px solid var(--border);
    }
    .pill input{ transform: translateY(1px); }

    .container{
      max-width:1100px;
      margin:0 auto;
      padding:14px 14px 28px;
    }

    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
    }
    @media (max-width: 960px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ min-width: unset; }
    }

    .card{
      background: var(--card);
      border:1px solid rgba(2,6,23,.08);
      box-shadow: var(--shadow);
      border-radius: var(--radius-lg);
      overflow:hidden;
    }
    .card-body{ padding: 16px; }

    .card-header{
      padding: 16px 16px 0;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .card-title{
      margin:0;
      font-size:16px;
      font-weight:900;
    }
    .card-desc{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    .accent{
      height: 10px;
      background: linear-gradient(90deg, var(--brand), var(--brand-2), var(--brand-3));
    }

    .input, .textarea, select{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.16);
      padding: 10px 12px;
      font-size: 14px;
      outline:none;
      background:#fff;
    }
    .textarea{ resize:vertical; font-size:15px; }
    .textarea:focus, .input:focus, select:focus{
      border-color: rgba(37,99,235,.5);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }
    .hint{
      margin:6px 0 0;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    code{ background: rgba(2,6,23,.06); padding:2px 6px; border-radius: 8px; }

    .sections{
      margin-top: 12px;
      display:grid;
      gap:10px;
    }
    .section-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.85);
      cursor:pointer;
      box-shadow: 0 6px 14px rgba(2,6,23,.05);
    }
    .section-item.active{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
      background:#fff;
    }
    .section-left{ min-width:0; }
    .section-title{ font-weight:900; font-size:14px; margin:0; }
    .section-meta{ font-size:12px; color: var(--muted); margin-top:2px; }
    .section-right{
      font-weight:900;
      min-width: 22px;
      text-align:right;
      color: rgba(34,197,94,1);
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 720px){ .row2{ grid-template-columns: 1fr; } }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }

    .terminal{
      margin-top: 12px;
      background: #0b1220;
      color:#e5e7eb;
      border-radius: 16px;
      padding: 12px;
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.35;
      min-height: 92px;
      overflow:auto;
      white-space: pre-wrap;
      border: 1px solid rgba(255,255,255,.08);
    }

    .progress{
      display:flex; align-items:center; gap:12px;
      margin-top: 12px;
    }
    .progress-bar{
      flex:1;
      height: 10px;
      background: rgba(15,23,42,.08);
      border-radius:999px;
      overflow:hidden;
    }
    .progress-fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(37,99,235,.85), rgba(255,177,0,.85));
      border-radius:999px;
      transition: width .25s ease;
    }
    .progress-label{
      font-size: 13px;
      color: var(--muted);
      min-width: 120px;
      text-align:right;
    }

    /* Drawer */
    .drawer{ position:fixed; inset:0; display:none; z-index:50; }
    .drawer[data-open="true"]{ display:block; }
    .drawer-overlay{ position:absolute; inset:0; background: rgba(2,6,23,.35); }
    .drawer-panel{
      position:absolute; top:0; bottom:0; left:0;
      width: min(440px, 92vw);
      background:#fff;
      box-shadow: 30px 0 60px rgba(2,6,23,.18);
      border-right:1px solid var(--border);
      display:flex; flex-direction:column;
    }
    .drawer-header{
      padding: 14px 14px;
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid var(--border);
    }
    .drawer-title{ font-weight:900; font-size:16px; }
    .drawer-content{ padding: 14px; overflow:auto; }

    .small{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      line-height:1.35;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">OD</div>
        <div>
          <h1>Orientador de TCC Digital</h1>
          <p>Editor por seções + IA (Worker) + exportação</p>
        </div>
      </div>

      <div class="toolbar">
        <label class="pill">
          <input type="checkbox" id="evidenceMode" />
          <span>Modo Evidência</span>
        </label>
        <button class="btn ghost" id="btnMenu" type="button">Configurações</button>
        <button class="btn blue" id="btnExportPDF" type="button">Exportar PDF</button>
        <button class="btn blue" id="btnExportDOCX" type="button">Exportar Word</button>
      </div>
    </div>
  </header>

  <main class="container">

    <div class="card">
      <div class="accent"></div>
      <div class="card-body">
        <div class="progress">
          <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="progress-label"><span id="progressValue">0%</span> completo</div>
        </div>
        <p class="hint" style="margin-top:10px">
          Dica: escreva um briefing e clique em <b>Gerar com IA</b>. O texto gerado entra na seção atual.
        </p>
      </div>
    </div>

    <div class="grid">
      <!-- Esquerda -->
      <section class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">Estrutura do TCC</h2>
            <p class="card-desc">Clique numa seção para editar. “Preenchido” aparece quando a seção tiver texto.</p>
          </div>
        </div>
        <div class="card-body">
          <div id="sectionsList" class="sections"></div>
        </div>
      </section>

      <!-- Direita -->
      <section class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title" id="sectionEditorTitle">Seção</h2>
            <p class="card-desc" id="sectionEditorDesc">Edite o texto e salve. A IA usa o briefing para gerar conteúdo.</p>
          </div>
        </div>

        <div class="card-body">
          <div class="row2">
            <div>
              <label class="hint" style="display:block;margin-bottom:6px">Título do Projeto</label>
              <input id="projectTitle" class="input" type="text" placeholder="Título do trabalho" />
            </div>
            <div>
              <label class="hint" style="display:block;margin-bottom:6px">Autor</label>
              <input id="authorName" class="input" type="text" placeholder="Seu nome" />
            </div>
          </div>

          <div style="height:10px"></div>

          <label class="hint" style="display:block;margin-bottom:6px">Briefing do aluno (o que a IA deve escrever nesta seção)</label>
          <textarea id="studentBrief" class="textarea" rows="4" placeholder="Ex.: Faça uma introdução acadêmica sobre Gestão da Informação em bibliotecas universitárias, com foco em tecnologia educacional."></textarea>

          <div class="actions">
            <button class="btn primary" id="btnGenerate" type="button">Gerar com IA (seção atual)</button>
            <button class="btn" id="btnApplyBrief" type="button">Aplicar briefing na seção</button>
            <button class="btn" id="btnSave" type="button">Salvar seção</button>
            <button class="btn ghost" id="btnQuickSave" type="button">Salvar (rápido)</button>
          </div>

          <div style="height:10px"></div>

          <label class="hint" style="display:block;margin-bottom:6px">Conteúdo da seção (editável)</label>
          <textarea id="sectionEditorText" class="textarea" rows="14" placeholder="O texto da seção selecionada aparece aqui..."></textarea>

          <pre class="terminal" id="terminal" aria-live="polite">Pronto. Se aparecer “Failed to fetch”, o problema está no Worker (CORS/OPTIONS) ou endpoint.</pre>
        </div>
      </section>
    </div>
  </main>

  <!-- Drawer -->
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer-overlay" id="drawerOverlay"></div>
    <div class="drawer-panel" role="dialog" aria-modal="true" aria-label="Configurações">
      <div class="drawer-header">
        <div class="drawer-title">Configurações</div>
        <button class="btn" id="btnCloseDrawer" type="button">Fechar</button>
      </div>

      <div class="drawer-content">
        <label class="hint" style="display:block;margin-bottom:6px">Endpoint do Worker (precisa terminar em <code>/assist</code>)</label>
        <input id="workerEndpoint" class="input" type="url" placeholder="https://SEU-WORKER.workers.dev/assist" />
        <div class="small">
          Se você usa Cloudflare Worker deste pacote, o endpoint será algo como:
          <code>https://orientador-tcc-api.SEU-USUARIO.workers.dev/assist</code>
        </div>

        <div style="height:14px"></div>

        <label class="hint" style="display:block;margin-bottom:6px">Instituição</label>
        <input id="institutionName" class="input" type="text" placeholder="Universidade / Faculdade" />

        <div class="actions">
          <button class="btn primary" id="btnSaveConfig" type="button">Salvar</button>
          <button class="btn ghost" id="btnResetAll" type="button">Resetar tudo</button>
        </div>

        <p class="small">
          Resetar tudo apaga os dados salvos do navegador deste site (localStorage) e volta ao padrão.
        </p>
      </div>
    </div>
  </aside>

  <script>
    /* =============================
       ESTADO (SEM BAGUNÇA)
    ============================== */
    const $ = (sel) => document.querySelector(sel);

    const LS_KEY = "od_state_v2";

    const TCC_STRUCTURE = [
      { id: "introducao", title: "1. Introdução", required: true },
      { id: "problema", title: "2. Problema de Pesquisa", required: true },
      { id: "objetivo_geral", title: "3. Objetivo Geral", required: true },
      { id: "objetivos_especificos", title: "4. Objetivos Específicos", required: true },
      { id: "justificativa", title: "5. Justificativa", required: true },
      { id: "referencial", title: "6. Referencial Teórico", required: true },
      { id: "metodologia", title: "7. Metodologia", required: true },
      { id: "resultados", title: "8. Resultados/Resultados Esperados", required: false },
      { id: "consideracoes_finais", title: "9. Considerações Finais", required: true },
      { id: "referencias", title: "Referências", required: true },
      { id: "anexos", title: "Anexos", required: false },
    ];

    const DEFAULT_STATE = {
      config: {
        workerEndpoint: "https://orientador-tcc-api.vitorjoseivan.workers.dev/assist",
        evidenceMode: false
      },
      meta: {
        projectTitle: "Orientador de TCC Digital",
        authorName: "José Ivan Vitor Cordeiro",
        institutionName: "Universidade Estadual do Ceará (UECE)"
      },
      selectedSectionId: "introducao",
      sections: TCC_STRUCTURE.reduce((acc, s) => {
        acc[s.id] = { title: s.title, content: "" };
        return acc;
      }, {})
    };

    function safeParse(raw){ try{ return JSON.parse(raw); } catch{ return null; } }

    function normalizeEndpoint(url){
      const u = (url || "").trim();
      if (!u) return "";
      if (!u.endsWith("/assist")) return u.replace(/\/+$/, "") + "/assist";
      return u;
    }

    function loadState(){
      const raw = localStorage.getItem(LS_KEY);
      const parsed = raw ? safeParse(raw) : null;
      const s = structuredClone(DEFAULT_STATE);

      if (parsed){
        if (parsed.config) s.config = { ...s.config, ...parsed.config };
        if (parsed.meta) s.meta = { ...s.meta, ...parsed.meta };
        if (parsed.selectedSectionId) s.selectedSectionId = parsed.selectedSectionId;
        if (parsed.sections) s.sections = { ...s.sections, ...parsed.sections };
      }
      s.config.workerEndpoint = normalizeEndpoint(s.config.workerEndpoint);
      return s;
    }

    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    function log(msg, append=false){
      const t = $("#terminal");
      if (!append) t.textContent = String(msg ?? "");
      else t.textContent = t.textContent + "\n" + String(msg ?? "");
    }

    function calcProgress(){
      const required = TCC_STRUCTURE.filter(s => s.required);
      const total = required.length || 1;
      const done = required.filter(s => (state.sections?.[s.id]?.content || "").trim().length > 40).length;
      return Math.round((done / total) * 100);
    }

    function setProgress(){
      const pct = calcProgress();
      $("#progressValue").textContent = pct + "%";
      $("#progressFill").style.width = pct + "%";
      document.querySelector(".progress-bar")?.setAttribute("aria-valuenow", String(pct));
    }

    function renderSections(){
      const root = $("#sectionsList");
      root.innerHTML = "";
      for (const s of TCC_STRUCTURE){
        const content = (state.sections[s.id]?.content || "").trim();
        const done = content.length > 40;

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "section-item" + (state.selectedSectionId === s.id ? " active" : "");
        btn.innerHTML = `
          <div class="section-left">
            <div class="section-title">${s.title}</div>
            <div class="section-meta">${s.required ? "Obrigatório" : "Opcional"} • ${done ? "Preenchido" : "Vazio"}</div>
          </div>
          <div class="section-right">${done ? "✓" : ""}</div>
        `;
        btn.addEventListener("click", () => {
          state.selectedSectionId = s.id;
          syncEditor();
          renderSections();
          saveState();
        });
        root.appendChild(btn);
      }
    }

    function syncEditor(){
      const sec = state.sections[state.selectedSectionId] || { title: "Seção", content: "" };
      $("#sectionEditorTitle").textContent = sec.title || "Seção";
      $("#sectionEditorText").value = sec.content || "";
      $("#projectTitle").value = state.meta.projectTitle || "";
      $("#authorName").value = state.meta.authorName || "";
    }

    function syncConfigUI(){
      $("#workerEndpoint").value = state.config.workerEndpoint || "";
      $("#institutionName").value = state.meta.institutionName || "";
      $("#evidenceMode").checked = !!state.config.evidenceMode;
    }

    function saveSection(){
      const text = $("#sectionEditorText").value || "";
      state.sections[state.selectedSectionId].content = text;
      saveState();
      renderSections();
      setProgress();
      log("Seção salva.");
    }

    function quickSave(){
      state.meta.projectTitle = ($("#projectTitle").value || "").trim();
      state.meta.authorName = ($("#authorName").value || "").trim();
      state.meta.institutionName = (state.meta.institutionName || "").trim();
      saveSection();
    }

    function openDrawer(open){
      $("#drawer").dataset.open = open ? "true" : "false";
      $("#drawer").setAttribute("aria-hidden", open ? "false" : "true");
    }

    function sectionToEtapa(sectionId){
      return sectionId; // agora é direto e simples
    }

    async function callWorker(etapa, texto){
      const endpoint = normalizeEndpoint(state.config.workerEndpoint);
      if (!endpoint) throw new Error("Endpoint vazio.");
      const payload = {
        etapa,
        texto,
        modo_evidencia: !!state.config.evidenceMode,
        meta: {
          titulo: state.meta.projectTitle,
          autor: state.meta.authorName,
          instituicao: state.meta.institutionName
        }
      };

      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 25000);

      try{
        const res = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          signal: controller.signal
        });
        const ct = res.headers.get("content-type") || "";
        const data = ct.includes("application/json") ? await res.json() : { text: await res.text() };
        if (!res.ok) throw new Error(data?.error || data?.message || ("HTTP " + res.status));
        return data;
      } finally {
        clearTimeout(timeout);
      }
    }

    async function generateWithIA(){
      const briefing = ($("#studentBrief").value || "").trim();
      if (briefing.length < 5){
        log("Escreva um briefing do aluno antes de gerar.");
        return;
      }

      state.meta.projectTitle = ($("#projectTitle").value || "").trim();
      state.meta.authorName = ($("#authorName").value || "").trim();

      const etapa = sectionToEtapa(state.selectedSectionId);

      log("Chamando o Worker... etapa: " + etapa);

      try{
        const data = await callWorker(etapa, briefing);
        const out = (data?.text || data?.resultado || data?.content || "").trim();
        if (!out) throw new Error("Worker respondeu sem texto (campo text vazio).");

        $("#sectionEditorText").value = out;
        state.sections[state.selectedSectionId].content = out;

        saveState();
        renderSections();
        setProgress();

        log("Texto gerado e aplicado na seção.");
      }catch(err){
        log(
`ERRO ao chamar o Worker:
${String(err?.message || err)}

Possíveis causas:
1) CORS no Worker (precisa responder OPTIONS e enviar Access-Control-Allow-Origin)
2) Endpoint errado (tem que terminar em /assist)
3) Worker offline ou com erro interno`
        );
      }
    }

    function applyBrief(){
      const briefing = ($("#studentBrief").value || "").trim();
      if (!briefing){
        log("Não há briefing para aplicar.");
        return;
      }
      const current = ($("#sectionEditorText").value || "").trim();
      const merged = current ? (current + "\n\n[Briefing]\n" + briefing) : briefing;
      $("#sectionEditorText").value = merged;
      log("Briefing aplicado na seção (não gerou IA; apenas inseriu o texto).");
    }

    async function exportPDF(){
      const { jsPDF } = window.jspdf || {};
      if (!jsPDF){ log("Erro: jsPDF não carregou (CDN)."); return; }

      quickSave();

      const doc = new jsPDF({ unit:"pt", format:"a4" });
      const margin = 48;
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const maxWidth = pageWidth - margin * 2;

      let y = margin;

      function addLine(txt, size=12, bold=false){
        doc.setFont("helvetica", bold ? "bold" : "normal");
        doc.setFontSize(size);
        const lines = doc.splitTextToSize(txt, maxWidth);
        for (const line of lines){
          if (y > pageHeight - margin){
            doc.addPage(); y = margin;
          }
          doc.text(line, margin, y);
          y += size + 6;
        }
      }

      addLine(state.meta.projectTitle || "Título do Projeto", 16, true);
      addLine(`Autor: ${state.meta.authorName || "-"}`, 11);
      addLine(`Instituição: ${state.meta.institutionName || "-"}`, 11);
      y += 8;

      for (const s of TCC_STRUCTURE){
        const content = (state.sections[s.id]?.content || "").trim();
        if (!content) continue;
        y += 8;
        addLine(s.title, 13, true);
        addLine(content, 11, false);
      }

      doc.save("orientador_tcc.pdf");
      log("PDF exportado.");
    }

    async function exportDOCX(){
      quickSave();

      const { Document, Packer, Paragraph, TextRun } = window.docx || {};
      if (!Document){ log("Erro: docx não carregou (CDN)."); return; }

      const children = [];
      children.push(new Paragraph({
        children: [new TextRun({ text: state.meta.projectTitle || "Título do Projeto", bold:true, size:32 })]
      }));
      children.push(new Paragraph({ text: `Autor: ${state.meta.authorName || "-"}` }));
      children.push(new Paragraph({ text: `Instituição: ${state.meta.institutionName || "-"}` }));
      children.push(new Paragraph({ text: "" }));

      for (const s of TCC_STRUCTURE){
        const content = (state.sections[s.id]?.content || "").trim();
        if (!content) continue;

        children.push(new Paragraph({
          children: [new TextRun({ text: s.title, bold:true, size:26 })]
        }));

        const parts = content.split(/\n{2,}/g);
        for (const p of parts){
          children.push(new Paragraph({ text: p.trim() }));
        }
        children.push(new Paragraph({ text: "" }));
      }

      const doc = new Document({ sections: [{ properties: {}, children }] });
      const blob = await Packer.toBlob(doc);
      saveAs(blob, "orientador_tcc.docx");
      log("Word exportado.");
    }

    /* =============================
       BOOT
    ============================== */
    let state = loadState();

    // UI wiring
    $("#btnMenu").addEventListener("click", () => openDrawer(true));
    $("#btnCloseDrawer").addEventListener("click", () => openDrawer(false));
    $("#drawerOverlay").addEventListener("click", () => openDrawer(false));

    $("#btnSave").addEventListener("click", saveSection);
    $("#btnQuickSave").addEventListener("click", quickSave);
    $("#btnApplyBrief").addEventListener("click", applyBrief);
    $("#btnGenerate").addEventListener("click", generateWithIA);

    $("#btnExportPDF").addEventListener("click", exportPDF);
    $("#btnExportDOCX").addEventListener("click", exportDOCX);

    $("#evidenceMode").addEventListener("change", (e) => {
      state.config.evidenceMode = !!e.target.checked;
      saveState();
      log("Modo Evidência " + (state.config.evidenceMode ? "ativado." : "desativado."));
    });

    $("#btnSaveConfig").addEventListener("click", () => {
      state.config.workerEndpoint = normalizeEndpoint($("#workerEndpoint").value);
      state.meta.institutionName = ($("#institutionName").value || "").trim();
      saveState();
      log("Configurações salvas.");
      openDrawer(false);
    });

    $("#btnResetAll").addEventListener("click", () => {
      localStorage.removeItem(LS_KEY);
      state = loadState();
      renderSections();
      syncEditor();
      syncConfigUI();
      setProgress();
      log("Tudo resetado para o padrão.");
      openDrawer(false);
    });

    // Autosave (texto)
    let autosaveTimer = null;
    $("#sectionEditorText").addEventListener("input", () => {
      clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(() => {
        state.sections[state.selectedSectionId].content = $("#sectionEditorText").value || "";
        saveState();
        renderSections();
        setProgress();
      }, 600);
    });

    // Initial render
    renderSections();
    syncEditor();
    syncConfigUI();
    setProgress();
  </script>
</body>
</html>
