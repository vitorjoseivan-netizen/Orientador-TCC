<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Orientador de TCC Digital</title>
    
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <style>
        :root {
            --bg: #ffffff;
            --bg-panel: #f8fafc;
            --line: #e2e8f0;
            --text: #1e293b;
            --muted: #64748b;
            --p1: #2563eb; /* Azul Profissional */
            --p2: #16a34a; /* Verde */
            --danger: #ef4444;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; }
        body {
            margin: 0; font-family: 'Inter', system-ui, sans-serif; 
            color: var(--text); background-color: var(--bg);
            height: 100vh; overflow: hidden;
        }

        .topbar {
            height: 64px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; border-bottom: 1px solid var(--line); background: #fff;
        }

        .layout {
            display: grid; grid-template-columns: 300px 1fr; gap: 15px;
            height: calc(100vh - 64px); padding: 15px;
        }

        .panel {
            background: var(--bg-panel); border: 1px solid var(--line);
            border-radius: 12px; display: flex; flex-direction: column; overflow: hidden;
            box-shadow: var(--shadow);
        }

        .scroll { overflow-y: auto; padding: 20px; flex: 1; }

        .section-item {
            width: 100%; padding: 12px; border-radius: 8px; background: #fff;
            border: 1px solid var(--line); color: var(--text); text-align: left;
            margin-bottom: 8px; cursor: pointer; transition: 0.2s;
        }
        .section-item:hover { border-color: var(--p1); background: #f1f5f9; }
        .section-item.active { border-color: var(--p1); background: #eff6ff; font-weight: 600; }

        textarea {
            width: 100%; background: #fff; border: 1px solid var(--line);
            border-radius: 8px; color: var(--text); padding: 12px; font-family: inherit;
            font-size: 14px; line-height: 1.6; resize: none; margin-bottom: 15px;
        }

        .btn {
            padding: 10px 20px; border-radius: 8px; border: 1px solid var(--line);
            cursor: pointer; font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary { background: var(--p1); color: white; border: none; }
        .btn-success { background: var(--p2); color: white; border: none; }
        .btn-ghost { background: #fff; color: var(--muted); }

        .terminal {
            background: #f1f5f9; padding: 12px; border-radius: 8px;
            font-family: monospace; font-size: 12px; color: var(--text);
            border-left: 4px solid var(--p1); min-height: 50px;
        }

        #drawer {
            position: fixed; right: -400px; top: 0; width: 350px; height: 100%;
            background: #fff; border-left: 1px solid var(--line);
            z-index: 1000; transition: 0.4s; padding: 25px; box-shadow: -10px 0 30px rgba(0,0,0,0.05);
        }
        #drawer.open { right: 0; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.2); display: none; z-index: 999; }
    </style>
</head>
<body>

<div class="overlay" id="overlay" onclick="toggleDrawer(false)"></div>

<header class="topbar">
    <div style="font-weight:800; font-size:20px; color:var(--p1)">Orientador Digital</div>
    <div style="display:flex; gap:10px">
        <button class="btn btn-ghost" onclick="toggleDrawer(true)">‚öôÔ∏è Configurar</button>
        <button class="btn btn-primary" onclick="exportWord()">üì• Baixar Word</button>
    </div>
</header>

<div class="layout">
    <aside class="panel">
        <div style="padding:15px; background:#fff; border-bottom:1px solid var(--line)"><strong>ESTRUTURA TCC</strong></div>
        <div class="scroll" id="stepsList"></div>
    </aside>

    <main class="panel">
        <div class="scroll">
            <h2 id="sectionTitle" style="margin-top:0">Selecione uma etapa</h2>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <label style="font-size:12px; font-weight:bold; color:var(--muted)">ORIENTA√á√ïES DA IA (BRIEFING)</label>
                    <textarea id="briefingInput" style="height:150px" placeholder="O que voc√™ quer que a IA escreva ou corrija nesta se√ß√£o?"></textarea>
                    <button class="btn btn-primary" id="btnIA" onclick="callIA()" style="width:100%">‚ú® Gerar com Intelig√™ncia Artificial</button>
                </div>
                <div>
                    <label style="font-size:12px; font-weight:bold; color:var(--muted)">BASE DE DADOS / PDF</label>
                    <textarea id="evidenceInput" style="height:150px" placeholder="Cole aqui trechos de livros ou o texto extra√≠do do seu PDF..."></textarea>
                    <input type="file" id="pdfFile" accept=".pdf" style="display:none" onchange="extractPDF()">
                    <button class="btn btn-ghost" style="width:100%" onclick="document.getElementById('pdfFile').click()">üìÑ Importar Texto de PDF</button>
                </div>
            </div>

            <h3 style="margin-top:30px; border-bottom: 2px solid var(--line); padding-bottom:10px">Conte√∫do da Se√ß√£o</h3>
            <textarea id="mainContent" style="height:350px" oninput="saveCurrentData()" placeholder="Escreva aqui ou use a IA para gerar..."></textarea>
            
            <div class="terminal" id="terminal">Pronto para iniciar sua orienta√ß√£o.</div>
        </div>
    </main>
</div>

<div id="drawer">
    <h3>Configura√ß√µes</h3>
    <label style="display:block; margin-bottom:5px">Link do Worker (Cloudflare)</label>
    <input type="text" id="workerUrl" style="width:100%; padding:10px; margin-bottom:20px; border:1px solid var(--line); border-radius:5px;">
    
    <label style="display:block; margin-bottom:5px">T√≠tulo do Projeto</label>
    <input type="text" id="workTitle" style="width:100%; padding:10px; margin-bottom:20px; border:1px solid var(--line); border-radius:5px;">
    
    <button class="btn btn-primary" style="width:100%" onclick="saveConfig()">Salvar e Fechar</button>
</div>

<script>
    // Configura√ß√µes e Estrutura
    const STRUCTURE = [
        { id: 'capa', title: 'Capa e Folha de Rosto' },
        { id: 'resumo', title: 'Resumo' },
        { id: 'intro', title: '1. Introdu√ß√£o' },
        { id: 'prob', title: '2. Problema de Pesquisa' },
        { id: 'obj', title: '3. Objetivos' },
        { id: 'just', title: '4. Justificativa' },
        { id: 'ref', title: '5. Referencial Te√≥rico' },
        { id: 'meto', title: '6. Metodologia' },
        { id: 'concl', title: '7. Conclus√£o' },
        { id: 'refere', title: '8. Refer√™ncias' }
    ];

    let state = JSON.parse(localStorage.getItem('tcc_white_v1')) || {
        config: { worker: "https://orientador-tcc-api.vitorjoseivan.workers.dev/assist", title: "Meu TCC de Administra√ß√£o" },
        activeId: 'intro',
        data: {}
    };

    function init() {
        renderSteps();
        loadStep(state.activeId);
        document.getElementById('workerUrl').value = state.config.worker;
        document.getElementById('workTitle').value = state.config.title;
    }

    function renderSteps() {
        const list = document.getElementById('stepsList');
        list.innerHTML = "";
        STRUCTURE.forEach(s => {
            const btn = document.createElement('button');
            btn.className = `section-item ${state.activeId === s.id ? 'active' : ''}`;
            btn.innerText = s.title;
            btn.onclick = () => loadStep(s.id);
            list.appendChild(btn);
        });
    }

    function loadStep(id) {
        state.activeId = id;
        const s = STRUCTURE.find(x => x.id === id);
        document.getElementById('sectionTitle').innerText = s.title;
        document.getElementById('mainContent').value = state.data[id]?.content || "";
        document.getElementById('evidenceInput').value = state.data[id]?.evidence || "";
        renderSteps();
    }

    function saveCurrentData() {
        if(!state.data[state.activeId]) state.data[state.activeId] = {};
        state.data[state.activeId].content = document.getElementById('mainContent').value;
        state.data[state.activeId].evidence = document.getElementById('evidenceInput').value;
        localStorage.setItem('tcc_white_v1', JSON.stringify(state));
    }

    async function callIA() {
        const briefing = document.getElementById('briefingInput').value;
        const terminal = document.getElementById('terminal');
        const btn = document.getElementById('btnIA');

        if(!briefing) return terminal.innerText = "Erro: Digite o briefing!";
        
        btn.disabled = true;
        terminal.innerText = "Conectando ao Orientador Digital... (IA processando)";

        try {
            const response = await fetch(state.config.worker, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: briefing, // Nome padr√£o que o Worker espera
                    etapa: state.activeId,
                    evidencias: document.getElementById('evidenceInput').value
                })
            });
            const data = await response.json();
// Esta linha abaixo √© a mais importante:
const aiText = data.text || data.answer || data.resultado || data.response;
            
            if(aiText) {
                document.getElementById('mainContent').value = aiText;
                saveCurrentData();
                terminal.innerText = "Sucesso! IA gerou o conte√∫do.";
            } else {
                terminal.innerText = "Erro: IA respondeu, mas o texto veio vazio.";
            }
        } catch (e) {
            terminal.innerText = "Erro de Conex√£o: Verifique o link do Worker ou CORS.";
        } finally {
            btn.disabled = false;
        }
    }

    async function extractPDF() {
        const file = document.getElementById('pdfFile').files[0];
        if(!file) return;
        document.getElementById('terminal').innerText = "Lendo PDF... aguarde.";
        const reader = new FileReader();
        reader.onload = async function() {
            const pdf = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
            let text = "";
            for(let i=1; i<=pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(it => it.str).join(" ") + "\n";
            }
            document.getElementById('evidenceInput').value = text;
            saveCurrentData();
            document.getElementById('terminal').innerText = "PDF Extra√≠do!";
        };
        reader.readAsArrayBuffer(file);
    }

    function toggleDrawer(open) {
        document.getElementById('drawer').className = open ? 'open' : '';
        document.getElementById('overlay').style.display = open ? 'block' : 'none';
    }

    function saveConfig() {
        state.config.worker = document.getElementById('workerUrl').value;
        state.config.title = document.getElementById('workTitle').value;
        localStorage.setItem('tcc_white_v1', JSON.stringify(state));
        toggleDrawer(false);
    }

    async function exportWord() {
        const { Document, Packer, Paragraph, TextRun, HeadingLevel } = window.docx;
        const children = [new Paragraph({ text: state.config.title, heading: HeadingLevel.TITLE, alignment: "CENTER" })];

        STRUCTURE.forEach(s => {
            if(state.data[s.id]?.content) {
                children.push(new Paragraph({ text: s.title, heading: HeadingLevel.HEADING_1, spacing: { before: 400 } }));
                children.push(new Paragraph({ children: [new TextRun(state.data[s.id].content)] }));
            }
        });

        const doc = new Document({ sections: [{ children }] });
        const blob = await Packer.toBlob(doc);
        saveAs(blob, "Trabalho_TCC.docx");
    }

    init();
</script>
</body>
</html>
