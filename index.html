<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orientador Digital (TCC/Artigo)</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- PDF.js (importar/extrair texto) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.js"></script>

  <!-- DOCX export -->
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <!-- DOCX import (Mammoth) -->
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>

  <!-- PDF export (jsPDF) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --panel:#f8fafc;
      --card:#ffffff;
      --line:#e2e8f0;
      --text:#0f172a;
      --muted:#64748b;
      --p1:#2563eb;  /* azul */
      --p2:#16a34a;  /* verde */
      --p3:#f59e0b;  /* âmbar */
      --danger:#ef4444;
      --shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
      --shadow2: 0 6px 14px rgba(15, 23, 42, 0.08);
      --radius: 14px;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:var(--bg);
      overflow:hidden;
    }

    /* Topbar */
    .topbar{
      height:68px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 18px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,0.9);
      backdrop-filter:saturate(180%) blur(10px);
      position:sticky;
      top:0;
      z-index:50;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:40px; height:40px; border-radius:12px;
      background: linear-gradient(135deg, rgba(37,99,235,1) 0%, rgba(22,163,74,1) 100%);
      box-shadow: var(--shadow2);
    }
    .brand h1{
      margin:0;
      font-size:16px;
      font-weight:900;
      letter-spacing:0.2px;
      line-height:1.1;
    }
    .brand .sub{
      margin:0;
      color:var(--muted);
      font-size:12px;
      font-weight:600;
    }

    .top-actions{
      display:flex; gap:10px; align-items:center;
    }

    /* Layout */
    .layout{
      height: calc(100vh - 68px);
      display:grid;
      grid-template-columns: 340px 1fr;
      gap: 14px;
      padding: 14px;
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .panel-head{
      padding: 14px 14px;
      background: #fff;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .panel-title{
      font-size: 13px;
      font-weight: 900;
      letter-spacing: 0.4px;
      color: var(--text);
    }

    .scroll{
      overflow:auto;
      padding: 14px;
      min-height:0;
      flex:1;
    }

    /* Buttons */
    .btn{
      appearance:none;
      border: 1px solid var(--line);
      background:#fff;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 800;
      font-size: 13px;
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .04s ease, border-color .2s ease, background .2s ease, box-shadow .2s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ border-color: rgba(37,99,235,0.45); box-shadow: 0 6px 14px rgba(15,23,42,0.08); }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ opacity:0.6; cursor:not-allowed; box-shadow:none; }

    .btn-primary{ background: var(--p1); color:#fff; border: none; }
    .btn-success{ background: var(--p2); color:#fff; border: none; }
    .btn-warn{ background: var(--p3); color:#111827; border: none; }
    .btn-ghost{ background:#fff; color: var(--muted); }
    .btn-danger{ background: var(--danger); color:#fff; border:none; }

    .btn-slim{ padding:8px 10px; border-radius:10px; font-size:12px; }

    /* Inputs */
    .input, textarea, select{
      width:100%;
      border: 1px solid var(--line);
      border-radius: 12px;
      background:#fff;
      color: var(--text);
      padding: 10px 12px;
      font-family: inherit;
      font-size: 13px;
      line-height: 1.55;
      outline: none;
    }
    textarea{
      resize:none;
      min-height:140px;
    }
    .input:focus, textarea:focus, select:focus{
      border-color: rgba(37,99,235,0.65);
      box-shadow: 0 0 0 4px rgba(37,99,235,0.12);
    }
    .label{
      font-size: 11px;
      font-weight: 900;
      color: var(--muted);
      letter-spacing: 0.5px;
      text-transform: uppercase;
      margin: 0 0 8px 0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .hint{
      font-size: 11px;
      color: var(--muted);
      font-weight: 700;
      text-transform:none;
      letter-spacing:0;
    }

    /* Sidebar steps */
    .searchbox{ display:flex; gap:10px; }
    .step-list{ display:flex; flex-direction:column; gap:8px; }
    .step{
      width:100%;
      text-align:left;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background:#fff;
      cursor:pointer;
      transition: background .2s ease, border-color .2s ease;
    }
    .step:hover{ border-color: rgba(37,99,235,0.45); background: #f1f5f9; }
    .step.active{ border-color: rgba(37,99,235,0.8); background: rgba(37,99,235,0.08); }
    .step .t{ font-weight: 900; font-size: 13px; margin-bottom: 3px; }
    .step .m{ font-weight: 700; font-size: 12px; color: var(--muted); display:flex; gap:10px; flex-wrap:wrap; }

    /* Main */
    .main-head{
      display:flex;
      flex-direction:column;
      gap: 10px;
      padding: 16px 16px;
      background:#fff;
      border-bottom:1px solid var(--line);
    }
    .main-head-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .main-title{
      margin:0;
      font-size: 18px;
      font-weight: 950;
      letter-spacing:0.2px;
    }
    .meta-row{
      display:flex; gap:10px; flex-wrap:wrap;
      color: var(--muted);
      font-weight: 700;
      font-size: 12px;
    }
    .badge{
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 999px;
      padding: 6px 10px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .dot{
      width:10px; height:10px; border-radius: 999px;
      background: var(--p2);
    }
    .dot.warn{ background: var(--p3); }
    .dot.bad{ background: var(--danger); }

    .grid-2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 1050px){
      .layout{ grid-template-columns: 1fr; }
      body{ overflow:auto; }
      .grid-2{ grid-template-columns: 1fr; }
    }

    .card{
      background:#fff;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 6px 14px rgba(15,23,42,0.06);
    }

    .row-actions{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top: 10px;
    }

    .terminal{
      background: #0b1220;
      color: #e5e7eb;
      border-radius: 14px;
      padding: 12px 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.45;
      border: 1px solid rgba(255,255,255,0.12);
      min-height: 74px;
      white-space: pre-wrap;
    }
    .terminal .ok{ color:#86efac; font-weight:800; }
    .terminal .warn{ color:#fde68a; font-weight:800; }
    .terminal .bad{ color:#fca5a5; font-weight:800; }

    /* Drawer */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(15,23,42,0.35);
      display:none;
      z-index:200;
    }
    #drawer{
      position:fixed;
      top:0;
      right:-420px;
      width: 390px;
      height:100%;
      background:#fff;
      border-left: 1px solid var(--line);
      z-index:210;
      transition: right .35s ease;
      box-shadow: -16px 0 40px rgba(15,23,42,0.16);
      display:flex;
      flex-direction:column;
    }
    #drawer.open{ right:0; }
    .drawer-head{
      padding: 16px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .drawer-head h3{
      margin:0;
      font-size: 14px;
      font-weight: 950;
    }
    .drawer-body{
      padding: 16px;
      overflow:auto;
    }

    .sep{ height:1px; background: var(--line); margin: 14px 0; }

    .small{
      font-size: 11px;
      color: var(--muted);
      font-weight:700;
      line-height:1.45;
    }
  </style>
</head>
<body>

  <div class="overlay" id="overlay" onclick="toggleDrawer(false)"></div>

  <header class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Orientador Digital</h1>
        <p class="sub">TCC e Artigo • Importar/Exportar PDF e Word</p>
      </div>
    </div>

    <div class="top-actions">
      <button class="btn btn-ghost" onclick="toggleDrawer(true)">Configurações</button>
      <button class="btn btn-primary" onclick="exportWordAll()">Exportar Word</button>
      <button class="btn btn-warn" onclick="exportPdfAll()">Exportar PDF</button>
    </div>
  </header>

  <div class="layout">
    <!-- Sidebar -->
    <aside class="panel">
      <div class="panel-head">
        <div>
          <div class="panel-title">ESTRUTURA</div>
          <div class="small" id="structureInfo"></div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <select id="structureMode" class="input" style="width:auto; padding:8px 10px; border-radius:10px; font-weight:900;" onchange="switchStructure()">
            <option value="tcc">TCC</option>
            <option value="artigo">Artigo</option>
          </select>
        </div>
      </div>

      <div class="scroll">
        <div class="searchbox" style="margin-bottom:10px;">
          <input id="stepSearch" class="input" placeholder="Buscar seção..." oninput="renderSteps()" />
          <button class="btn btn-slim btn-ghost" onclick="clearSearch()">Limpar</button>
        </div>

        <div class="step-list" id="stepsList"></div>

        <div class="sep"></div>

        <div class="small">
          Dica: o conteúdo, briefing e evidências são salvos automaticamente por seção.
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="panel">
      <div class="main-head">
        <div class="main-head-top">
          <div>
            <h2 class="main-title" id="sectionTitle">Selecione uma etapa</h2>
            <div class="meta-row">
              <span class="badge"><span class="dot" id="saveDot"></span> <span id="saveState">Salvo</span></span>
              <span class="badge">Palavras: <span id="wordCount">0</span></span>
              <span class="badge">Seção: <span id="sectionIdLabel">—</span></span>
            </div>
          </div>

          <div style="display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap; justify-content:flex-end;">
            <button class="btn btn-ghost btn-slim" onclick="importDocxToCurrent()">Importar Word na seção</button>
            <button class="btn btn-ghost btn-slim" onclick="importPdfToEvidence()">Importar PDF para Evidências</button>
            <button class="btn btn-danger btn-slim" onclick="clearCurrentSection()">Limpar seção</button>
          </div>
        </div>
      </div>

      <div class="scroll">
        <div class="grid-2">
          <div class="card">
            <div class="label">
              <span>ORIENTAÇÕES DA IA (BRIEFING)</span>
              <span class="hint">O que a IA deve produzir nesta seção</span>
            </div>
            <textarea id="briefingInput" placeholder="Ex.: Escreva a introdução delimitando contexto, lacuna, objetivo e estrutura do artigo/TCC..." oninput="saveCurrentDataDebounced()"></textarea>
            <div class="row-actions">
              <button class="btn btn-primary" id="btnIA" onclick="callIA()">Gerar com IA</button>
              <button class="btn btn-ghost" onclick="appendToContentFromBriefing()">Adicionar briefing ao conteúdo</button>
            </div>
          </div>

          <div class="card">
            <div class="label">
              <span>EVIDÊNCIAS / BASE (PDF/REFERÊNCIAS)</span>
              <span class="hint">Cole trechos ou extraia do PDF</span>
            </div>
            <textarea id="evidenceInput" placeholder="Cole trechos de livros, artigos, citações, dados, etc." oninput="saveCurrentDataDebounced()"></textarea>

            <div class="row-actions">
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn btn-ghost" onclick="copyEvidence()">Copiar evidências</button>
                <button class="btn btn-ghost" onclick="clearEvidence()">Limpar evidências</button>
              </div>
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn btn-ghost" onclick="document.getElementById('pdfFile').click()">Selecionar PDF</button>
                <input type="file" id="pdfFile" accept=".pdf" style="display:none" onchange="extractPDF()">
                <input type="file" id="docxFile" accept=".docx" style="display:none" onchange="handleDocxImportFile(event)">
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top: 14px;">
          <div class="label">
            <span>CONTEÚDO DA SEÇÃO</span>
            <span class="hint">Escreva aqui ou gere via IA</span>
          </div>
          <textarea id="mainContent" style="min-height: 320px;" placeholder="Escreva aqui..." oninput="onContentInput()"></textarea>

          <div class="row-actions">
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn btn-success" onclick="exportWordCurrent()">Exportar Word (seção)</button>
              <button class="btn btn-warn" onclick="exportPdfCurrent()">Exportar PDF (seção)</button>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn btn-ghost" onclick="insertHeadingTemplate()">Inserir template da seção</button>
              <button class="btn btn-ghost" onclick="copyContent()">Copiar conteúdo</button>
            </div>
          </div>
        </div>

        <div style="margin-top: 14px;">
          <div class="terminal" id="terminal">Pronto para iniciar. Configure o Worker em “Configurações” se necessário.</div>
        </div>
      </div>
    </main>
  </div>

  <!-- Drawer Config -->
  <div id="drawer" aria-hidden="true">
    <div class="drawer-head">
      <h3>Configurações</h3>
      <button class="btn btn-ghost btn-slim" onclick="toggleDrawer(false)">Fechar</button>
    </div>
    <div class="drawer-body">
      <div class="label">Título do Projeto</div>
      <input type="text" id="workTitle" class="input" placeholder="Ex.: Meu TCC / Meu Artigo" />

      <div class="sep"></div>

      <div class="label">URL do Worker (Cloudflare)</div>
      <input type="text" id="workerUrl" class="input" placeholder="https://seu-worker.workers.dev/assist" />
      <div class="small" style="margin-top:8px;">
        O front envia <strong>prompt</strong>, <strong>etapa</strong> e <strong>evidencias</strong>. O Worker deve retornar JSON com <strong>{ "text": "..." }</strong>.
      </div>

      <div class="sep"></div>

      <div class="label">Persistência local</div>
      <div class="small">
        Os dados ficam no seu navegador (localStorage). Se limpar cache/dados do site, perde o conteúdo.
      </div>

      <div class="sep"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn btn-primary" style="flex:1;" onclick="saveConfig()">Salvar</button>
        <button class="btn btn-danger" style="flex:1;" onclick="resetAll()">Resetar tudo</button>
      </div>
    </div>
  </div>

<script>
  /* =========================
     ESTRUTURAS: TCC e ARTIGO
  ========================== */
  const STRUCTURE_TCC = [
    { id:'capa',   title:'Capa e Folha de Rosto' },
    { id:'resumo', title:'Resumo' },
    { id:'intro',  title:'1. Introdução' },
    { id:'prob',   title:'2. Problema de Pesquisa' },
    { id:'obj',    title:'3. Objetivos' },
    { id:'just',   title:'4. Justificativa' },
    { id:'ref',    title:'5. Referencial Teórico' },
    { id:'meto',   title:'6. Metodologia' },
    { id:'result', title:'7. Resultados' },
    { id:'disc',   title:'8. Discussão' },
    { id:'concl',  title:'9. Conclusão' },
    { id:'refs',   title:'10. Referências' }
  ];

  const STRUCTURE_ARTIGO = [
    { id:'titulo',   title:'Título' },
    { id:'autores',  title:'Autores e Afiliações' },
    { id:'resumo',   title:'Resumo' },
    { id:'palavras', title:'Palavras-chave' },
    { id:'abstract', title:'Abstract' },
    { id:'keywords', title:'Keywords' },
    { id:'intro',    title:'1. Introdução' },
    { id:'metodos',  title:'2. Materiais e Métodos' },
    { id:'result',   title:'3. Resultados' },
    { id:'disc',     title:'4. Discussão' },
    { id:'concl',    title:'5. Conclusão' },
    { id:'refs',     title:'Referências' }
  ];

  /* =========================
     STATE / STORAGE
  ========================== */
  const STORAGE_KEY = "orientador_robusto_v2";

  const defaultState = {
    config: {
      worker: "https://SEU-WORKER-AQUI.workers.dev/assist",
      title: "Meu Projeto",
    },
    mode: "tcc",        // "tcc" | "artigo"
    activeId: "intro",
    data: {}            // { [sectionId]: { content, evidence, briefing, updatedAt } }
  };

  let state = loadState();
  let saveTimer = null;

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return structuredClone(defaultState);
      const parsed = JSON.parse(raw);

      // Migração defensiva
      const s = { ...structuredClone(defaultState), ...parsed };
      s.config = { ...structuredClone(defaultState.config), ...(parsed.config || {}) };
      if(!["tcc","artigo"].includes(s.mode)) s.mode = "tcc";
      if(!s.data || typeof s.data !== "object") s.data = {};
      if(!s.activeId) s.activeId = "intro";
      return s;
    }catch{
      return structuredClone(defaultState);
    }
  }

  function persist(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function getStructure(){
    return state.mode === "artigo" ? STRUCTURE_ARTIGO : STRUCTURE_TCC;
  }

  function ensureSection(id){
    if(!state.data[id]) state.data[id] = { content:"", evidence:"", briefing:"", updatedAt: null };
    return state.data[id];
  }

  /* =========================
     UI HELPERS
  ========================== */
  function logTerminal(kind, message){
    const t = document.getElementById("terminal");
    const stamp = new Date().toLocaleString("pt-BR");
    let prefix = "INFO";
    let cls = "";
    if(kind === "ok"){ prefix = "OK"; cls = "ok"; }
    if(kind === "warn"){ prefix = "AVISO"; cls = "warn"; }
    if(kind === "bad"){ prefix = "ERRO"; cls = "bad"; }

    const line = `[${stamp}] ${prefix}: ${message}`;
    t.innerHTML = `${t.innerHTML}\n<span class="${cls}">${escapeHtml(line)}</span>`;
    t.scrollTop = t.scrollHeight;
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function setSaveState(status){
    const dot = document.getElementById("saveDot");
    const label = document.getElementById("saveState");
    if(status === "saving"){
      dot.className = "dot warn";
      label.textContent = "Salvando...";
      return;
    }
    if(status === "error"){
      dot.className = "dot bad";
      label.textContent = "Erro ao salvar";
      return;
    }
    dot.className = "dot";
    label.textContent = "Salvo";
  }

  function updateCounters(){
    const txt = document.getElementById("mainContent").value || "";
    const words = txt.trim() ? txt.trim().split(/\s+/).length : 0;
    document.getElementById("wordCount").textContent = String(words);
  }

  /* =========================
     RENDER / NAV
  ========================== */
  function init(){
    document.getElementById("workerUrl").value = state.config.worker;
    document.getElementById("workTitle").value = state.config.title;
    document.getElementById("structureMode").value = state.mode;

    const structure = getStructure();
    // Garantir activeId válido
    if(!structure.some(s => s.id === state.activeId)){
      state.activeId = structure[0]?.id || "intro";
    }

    renderSteps();
    loadStep(state.activeId);
    updateStructureInfo();
    setSaveState("saved");

    // terminal limpo e pronto
    document.getElementById("terminal").textContent = "Pronto. Selecione uma seção e utilize IA, importação e exportação.";
  }

  function updateStructureInfo(){
    const structure = getStructure();
    const filled = structure.filter(s => (state.data[s.id]?.content || "").trim().length > 0).length;
    document.getElementById("structureInfo").textContent =
      `${structure.length} seções • ${filled} com conteúdo`;
  }

  function renderSteps(){
    const list = document.getElementById("stepsList");
    const q = (document.getElementById("stepSearch").value || "").trim().toLowerCase();
    const structure = getStructure();

    list.innerHTML = "";
    structure
      .filter(s => !q || s.title.toLowerCase().includes(q) || s.id.toLowerCase().includes(q))
      .forEach(s => {
        const sec = ensureSection(s.id);
        const words = (sec.content || "").trim() ? sec.content.trim().split(/\s+/).length : 0;
        const hasEvidence = (sec.evidence || "").trim().length > 0;

        const btn = document.createElement("button");
        btn.className = `step ${state.activeId === s.id ? "active" : ""}`;
        btn.onclick = () => loadStep(s.id);

        btn.innerHTML = `
          <div class="t">${escapeHtml(s.title)}</div>
          <div class="m">
            <span>id: ${escapeHtml(s.id)}</span>
            <span>palavras: ${words}</span>
            <span>${hasEvidence ? "com evidências" : "sem evidências"}</span>
          </div>
        `;
        list.appendChild(btn);
      });

    updateStructureInfo();
  }

  function clearSearch(){
    document.getElementById("stepSearch").value = "";
    renderSteps();
  }

  function loadStep(id){
    state.activeId = id;
    const structure = getStructure();
    const s = structure.find(x => x.id === id) || structure[0];

    ensureSection(id);

    document.getElementById("sectionTitle").textContent = s ? s.title : "Seção";
    document.getElementById("sectionIdLabel").textContent = id;

    document.getElementById("mainContent").value = state.data[id]?.content || "";
    document.getElementById("evidenceInput").value = state.data[id]?.evidence || "";
    document.getElementById("briefingInput").value = state.data[id]?.briefing || "";

    updateCounters();
    renderSteps();
    persist();
    setSaveState("saved");
  }

  function switchStructure(){
    const mode = document.getElementById("structureMode").value;
    state.mode = mode;
    const structure = getStructure();
    if(!structure.some(s => s.id === state.activeId)){
      state.activeId = structure[0]?.id || "intro";
    }
    persist();
    renderSteps();
    loadStep(state.activeId);
    logTerminal("ok", `Estrutura alterada para: ${mode.toUpperCase()}`);
  }

  /* =========================
     SAVE (debounced)
  ========================== */
  function saveCurrentData(){
    try{
      const id = state.activeId;
      ensureSection(id);
      state.data[id].content = document.getElementById("mainContent").value || "";
      state.data[id].evidence = document.getElementById("evidenceInput").value || "";
      state.data[id].briefing = document.getElementById("briefingInput").value || "";
      state.data[id].updatedAt = Date.now();

      persist();
      setSaveState("saved");
      renderSteps();
    }catch{
      setSaveState("error");
    }
  }

  function saveCurrentDataDebounced(){
    setSaveState("saving");
    if(saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      saveCurrentData();
    }, 250);
  }

  function onContentInput(){
    updateCounters();
    saveCurrentDataDebounced();
  }

  /* =========================
     IA CALL
  ========================== */
  async function callIA(){
    const briefing = document.getElementById("briefingInput").value.trim();
    const evidence = document.getElementById("evidenceInput").value;
    const btn = document.getElementById("btnIA");

    if(!briefing){
      logTerminal("bad", "Digite o briefing antes de gerar.");
      return;
    }
    if(!state.config.worker || state.config.worker.includes("SEU-WORKER-AQUI")){
      logTerminal("warn", "Configure a URL do Worker em Configurações.");
      toggleDrawer(true);
      return;
    }

    btn.disabled = true;
    logTerminal("warn", "Enviando solicitação ao Worker...");

    try{
      const res = await fetch(state.config.worker, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          prompt: briefing,
          etapa: state.activeId,
          evidencias: evidence
        })
      });

      const data = await res.json().catch(()=> ({}));
      if(!res.ok){
        const msg = data?.text || data?.error || `HTTP ${res.status}`;
        logTerminal("bad", `Falha no Worker/OpenAI: ${msg}`);
        return;
      }

      const aiText = data.text || data.answer || data.resultado || data.response || "";
      if(!aiText.trim()){
        logTerminal("bad", "O Worker respondeu, mas o texto veio vazio.");
        return;
      }

      document.getElementById("mainContent").value = aiText;
      updateCounters();
      saveCurrentData();
      logTerminal("ok", "Conteúdo gerado e salvo na seção atual.");
    }catch(e){
      logTerminal("bad", "Erro de conexão: verifique URL do Worker e CORS.");
    }finally{
      btn.disabled = false;
    }
  }

  /* =========================
     PDF IMPORT (extract)
  ========================== */
  async function extractPDF(){
    const file = document.getElementById("pdfFile").files[0];
    if(!file) return;

    logTerminal("warn", `Lendo PDF: ${file.name}`);
    try{
      const reader = new FileReader();
      reader.onload = async function(){
        const pdf = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
        let text = "";
        for(let i=1; i<=pdf.numPages; i++){
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          text += content.items.map(it => it.str).join(" ") + "\n";
        }
        document.getElementById("evidenceInput").value = text.trim();
        saveCurrentData();
        logTerminal("ok", `PDF extraído (${pdf.numPages} páginas) e salvo em Evidências.`);
      };
      reader.readAsArrayBuffer(file);
    }catch(e){
      logTerminal("bad", "Falha ao extrair PDF. Tente outro arquivo.");
    }finally{
      document.getElementById("pdfFile").value = "";
    }
  }

  function importPdfToEvidence(){
    document.getElementById("pdfFile").click();
  }

  /* =========================
     DOCX IMPORT (Mammoth)
  ========================== */
  function importDocxToCurrent(){
    document.getElementById("docxFile").click();
  }

  async function handleDocxImportFile(event){
    const file = event.target.files?.[0];
    if(!file) return;

    logTerminal("warn", `Importando DOCX: ${file.name}`);
    try{
      const arrayBuffer = await file.arrayBuffer();
      const result = await mammoth.extractRawText({ arrayBuffer });
      const text = (result.value || "").trim();

      if(!text){
        logTerminal("bad", "DOCX importado, mas não foi possível extrair texto.");
        return;
      }

      // Importa no conteúdo da seção atual (sobrescreve)
      document.getElementById("mainContent").value = text;
      updateCounters();
      saveCurrentData();
      logTerminal("ok", "DOCX importado e aplicado ao conteúdo da seção atual.");
    }catch(e){
      logTerminal("bad", "Falha ao importar DOCX. Verifique se o arquivo está íntegro.");
    }finally{
      document.getElementById("docxFile").value = "";
    }
  }

  /* =========================
     EXPORT WORD (DOCX)
  ========================== */
  async function exportWordCurrent(){
    const { Document, Packer, Paragraph, TextRun, HeadingLevel } = window.docx;
    const structure = getStructure();
    const sec = structure.find(s => s.id === state.activeId);
    const title = state.config.title || "Projeto";

    const content = (document.getElementById("mainContent").value || "").trim();
    if(!content){
      logTerminal("warn", "Seção vazia. Nada para exportar.");
      return;
    }

    const children = [];
    children.push(new Paragraph({ text: title, heading: HeadingLevel.TITLE, alignment: "CENTER" }));
    children.push(new Paragraph({ text: sec?.title || state.activeId, heading: HeadingLevel.HEADING_1, spacing: { before: 400, after: 180 } }));
    children.push(new Paragraph({ children: [new TextRun(content)] }));

    const doc = new Document({ sections: [{ children }] });
    const blob = await Packer.toBlob(doc);
    saveAs(blob, `${sanitizeFileName(title)}_${state.activeId}.docx`);
    logTerminal("ok", "Word da seção exportado.");
  }

  async function exportWordAll(){
    const { Document, Packer, Paragraph, TextRun, HeadingLevel } = window.docx;
    const title = state.config.title || "Projeto";
    const structure = getStructure();

    const children = [
      new Paragraph({ text: title, heading: HeadingLevel.TITLE, alignment: "CENTER" }),
      new Paragraph({ text: `Estrutura: ${state.mode.toUpperCase()}`, spacing: { before: 200, after: 400 } })
    ];

    let any = false;
    structure.forEach(s => {
      const content = (state.data[s.id]?.content || "").trim();
      if(content){
        any = true;
        children.push(new Paragraph({ text: s.title, heading: HeadingLevel.HEADING_1, spacing: { before: 400, after: 180 } }));
        children.push(new Paragraph({ children: [new TextRun(content)] }));
      }
    });

    if(!any){
      logTerminal("warn", "Nenhuma seção com conteúdo para exportar.");
      return;
    }

    const doc = new Document({ sections: [{ children }] });
    const blob = await Packer.toBlob(doc);
    saveAs(blob, `${sanitizeFileName(title)}_${state.mode}.docx`);
    logTerminal("ok", "Word completo exportado.");
  }

  /* =========================
     EXPORT PDF (jsPDF)
  ========================== */
  function pdfAddWrappedText(doc, text, x, y, maxWidth, lineHeight){
    const lines = doc.splitTextToSize(text, maxWidth);
    for(const line of lines){
      if(y > 285){
        doc.addPage();
        y = 20;
      }
      doc.text(line, x, y);
      y += lineHeight;
    }
    return y;
  }

  async function exportPdfCurrent(){
    const { jsPDF } = window.jspdf;
    const title = state.config.title || "Projeto";
    const structure = getStructure();
    const sec = structure.find(s => s.id === state.activeId);

    const content = (document.getElementById("mainContent").value || "").trim();
    if(!content){
      logTerminal("warn", "Seção vazia. Nada para exportar.");
      return;
    }

    const doc = new jsPDF({ unit:"mm", format:"a4" });
    doc.setFont("times", "normal");
    doc.setFontSize(14);

    let y = 20;
    doc.text(title, 15, y); y += 10;

    doc.setFontSize(12);
    doc.text(sec?.title || state.activeId, 15, y); y += 10;

    doc.setFontSize(11);
    y = pdfAddWrappedText(doc, content, 15, y, 180, 6);

    doc.save(`${sanitizeFileName(title)}_${state.activeId}.pdf`);
    logTerminal("ok", "PDF da seção exportado.");
  }

  async function exportPdfAll(){
    const { jsPDF } = window.jspdf;
    const title = state.config.title || "Projeto";
    const structure = getStructure();

    const doc = new jsPDF({ unit:"mm", format:"a4" });
    doc.setFont("times", "normal");

    let y = 20;
    doc.setFontSize(14);
    doc.text(title, 15, y); y += 8;

    doc.setFontSize(11);
    doc.text(`Estrutura: ${state.mode.toUpperCase()}`, 15, y); y += 10;

    let any = false;
    for(const s of structure){
      const content = (state.data[s.id]?.content || "").trim();
      if(!content) continue;
      any = true;

      doc.setFontSize(12);
      if(y > 275){ doc.addPage(); y = 20; }
      doc.text(s.title, 15, y); y += 8;

      doc.setFontSize(11);
      y = pdfAddWrappedText(doc, content, 15, y, 180, 6);
      y += 6;
    }

    if(!any){
      logTerminal("warn", "Nenhuma seção com conteúdo para exportar.");
      return;
    }

    doc.save(`${sanitizeFileName(title)}_${state.mode}.pdf`);
    logTerminal("ok", "PDF completo exportado.");
  }

  /* =========================
     UTIL ACTIONS
  ========================== */
  function sanitizeFileName(name){
    return String(name).trim().replace(/[\\/:*?"<>|]+/g, "_").replace(/\s+/g, "_").slice(0, 80) || "arquivo";
  }

  function copyContent(){
    const text = document.getElementById("mainContent").value || "";
    navigator.clipboard?.writeText(text);
    logTerminal("ok", "Conteúdo copiado para a área de transferência.");
  }

  function copyEvidence(){
    const text = document.getElementById("evidenceInput").value || "";
    navigator.clipboard?.writeText(text);
    logTerminal("ok", "Evidências copiadas para a área de transferência.");
  }

  function clearEvidence(){
    document.getElementById("evidenceInput").value = "";
    saveCurrentData();
    logTerminal("ok", "Evidências limpas.");
  }

  function appendToContentFromBriefing(){
    const briefing = (document.getElementById("briefingInput").value || "").trim();
    if(!briefing){
      logTerminal("warn", "Briefing está vazio.");
      return;
    }
    const main = document.getElementById("mainContent");
    const sep = main.value.trim() ? "\n\n" : "";
    main.value = (main.value || "") + sep + briefing;
    updateCounters();
    saveCurrentData();
    logTerminal("ok", "Briefing anexado ao conteúdo.");
  }

  function insertHeadingTemplate(){
    const structure = getStructure();
    const sec = structure.find(s => s.id === state.activeId);
    const t = sec?.title || state.activeId;

    const templates = {
      // templates simples (você pode expandir)
      intro: "Apresente o contexto, delimite a lacuna, indique relevância e finalize com objetivo e estrutura do trabalho.\n",
      meto: "Descreva delineamento, procedimentos, população/amostra, instrumentos, análise de dados e aspectos éticos (se aplicável).\n",
      metodos: "Descreva delineamento, materiais, procedimentos e método de análise.\n",
      result: "Apresente os resultados de forma objetiva, com sínteses e indicadores quando aplicável.\n",
      disc: "Interprete os resultados, compare com a literatura, discuta limitações e implicações.\n",
      concl: "Sintetize achados, responda ao objetivo, destaque contribuições e recomendações.\n",
      refs: "Liste as referências conforme ABNT.\n",
      resumo: "Apresente objetivo, método, resultados e conclusão em um parágrafo. Inclua palavras-chave.\n",
      abstract: "Objective, method, results and conclusion in a single paragraph. Add keywords.\n"
    };

    const key = state.activeId;
    const snippet = templates[key] || `Modelo para ${t}: escreva com rigor acadêmico, coesão e clareza.\n`;

    const main = document.getElementById("mainContent");
    const sep = main.value.trim() ? "\n\n" : "";
    main.value = (main.value || "") + sep + snippet;
    updateCounters();
    saveCurrentData();
    logTerminal("ok", "Template inserido.");
  }

  function clearCurrentSection(){
    const id = state.activeId;
    if(!confirm("Limpar conteúdo, briefing e evidências desta seção?")) return;

    ensureSection(id);
    state.data[id].content = "";
    state.data[id].evidence = "";
    state.data[id].briefing = "";
    state.data[id].updatedAt = Date.now();
    persist();

    document.getElementById("mainContent").value = "";
    document.getElementById("evidenceInput").value = "";
    document.getElementById("briefingInput").value = "";
    updateCounters();
    renderSteps();
    logTerminal("ok", "Seção limpa.");
  }

  /* =========================
     CONFIG / DRAWER
  ========================== */
  function toggleDrawer(open){
    const drawer = document.getElementById("drawer");
    const overlay = document.getElementById("overlay");
    drawer.className = open ? "open" : "";
    overlay.style.display = open ? "block" : "none";
    drawer.setAttribute("aria-hidden", open ? "false" : "true");
  }

  function saveConfig(){
    state.config.worker = (document.getElementById("workerUrl").value || "").trim();
    state.config.title = (document.getElementById("workTitle").value || "").trim() || "Meu Projeto";
    persist();
    toggleDrawer(false);
    logTerminal("ok", "Configurações salvas.");
  }

  function resetAll(){
    if(!confirm("Isso apagará TODOS os dados salvos no navegador. Continuar?")) return;
    localStorage.removeItem(STORAGE_KEY);
    state = structuredClone(defaultState);
    persist();
    location.reload();
  }

  /* =========================
     INIT
  ========================== */
  init();
</script>
</body>
</html>
